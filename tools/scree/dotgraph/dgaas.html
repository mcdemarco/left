<!DOCTYPE html>
<html>
<head>
<title>
DotGraph as a Service (DotGraph)
</title>
<meta charset="utf-8">
<style>
 /* dot and settings */
 body {margin:3%;}
 tw-storydata {display:none;}
 #stats {font-style:italic;text-align:center;}
 input#omitTags, input#clusterTags {width:30%;}
 label {white-space:nowrap;}
 div#notes {max-width:50%;float:right;}
 div#notes p {font-size:smaller;margin-top: 0;}
 h2 {float:left;padding-right:3em;;text-decoration:underline;}
 section {clear:both;}
 section.sourceSubSection {display:none;}
 textarea {width: 100%; height:20em;}
 textarea.settings {height:16em; width:20em;}
 #graphSection {text-align:center;}
 #saveSvgButton {float:left;}
 #scaleInput {width:5em;}
 #scaleUpButton, #scaleDownButton {font-weight:bold;}
 /* dagre-d3 */
 svg#dagre .clusters rect {fill: #00ffd0;stroke: #999;stroke-width: 1.5px;}
 svg#dagre text {font-weight: 300;font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;font-size: 14px;}
 svg#dagre .node rect, svg#dagre .node circle, svg#dagre .node ellipse, svg#dagre .node diamond {stroke: #000;fill: #fff;stroke-width: 1.5px;}
 svg#dagre .edgePath path {stroke: #333;fill: #333;stroke-width: 1.5px;}
 svg#dagre .edgePath path.path {stroke: #333;fill: none;stroke-width: 1.5px;}
</style>
<script src="https://mcdemarco.net/tools/viz/viz.js" type="text/javascript"></script><script src="https://mcdemarco.net/tools/viz/full.render.js" type="text/javascript"></script>
<script src="https://mcdemarco.net/tools/viz/d3.v5.min.js" type="text/javascript"></script><script src="https://mcdemarco.net/tools/viz/dagre-d3.min.js" type="text/javascript"></script>
</head>
<body>
	<h1>DotGraph as a Service</h1>

	<div id="stats" title="Twine">
		<span id="nodeCount">0</span>&nbsp;nodes<span id="omitCount"></span>,
		<span id="leafCount">0</span>&nbsp;leaves<span id="looseCount"></span>,
		<span id="linkCount">0</span>&nbsp;links, and
		<span id="average">0</span>&nbsp;links&nbsp;per&nbsp;node.
	</div>

	<h2 id="settingsHeader">Settings</h2>
	<section id="settingsSection">
		<div id="notes">
			<div id="notesDiv">
							<p><b>Notes:</b> The start node is double-circled, as are any unreachable nodes.  When color by length is on, all real nodes are colored in shades of red (shorter than average) to blue (longer than average) based on the relative length of their contents.</p>
							<p>Stray or misplaced nodes can result from the omit tags setting, from duplicate passage names, scripted passage transitions, or other linking issues.</p>
							<p>The layout engine options change the graph style; some options are slower than the default ("dot").  The image format is SVG.</p>
							<p>Several output options are available for use in other graphing programs.  The JSON version also generates a graph using dagre-d3 instead of graphviz (online version only).  For more information, see <a href="http://mcdemarco.net/tools/scree/dotgraph/">the website</a> or <a href="https://github.com/mcdemarco/dotgraph/blob/master/README.md">the README</a>.</p>
			</div>
			<div id="settingsDisplayDiv" style="display:none;white-space:nowrap;">
							<div style="display:inline-block;">
											<b>Currently selected settings</b><br/>
											<textarea id="settingsTextarea" class="settings"></textarea>
							</div>
							<div style="display:inline-block;">
											<b>Settings found in story</b><br/>
											<textarea id="storySettingsTextarea" class="settings" placeholder="no settings"></textarea> 
							</div>
			</div>
		</div>
		<div>
						<form id="settingsForm">
						</form>
		</div>
	</section>

	<h2 id="graphHeader">Graph</h2>
	<section id="graphSection">
		<button type="button" id="saveSvgButton">Save Image</button>
		<label for="scaleCheckbox">Scale:</label>&nbsp;<input type="text" id="scaleInput" value="" />
		<button type="button" id="scaleDownButton">&ndash;</button>
		<button type="button" id="scaleUpButton">+</button>
		<div id="graph"></div>
		<hr style="clear:both;"/>
	</section>

	<h2 id="sourceHeader">Source</h2>
	<section id="sourceSection">
		<select id="sourceSelect">
			<option value="dot">dot</option>
			<option value="gml">GML</option>
			<option value="graphml">GraphML</option>
			<option value="json">JSON</option>
		</select>
		<button type="button" id="saveSourceButton">Save Source</button>

	<section id="dotSection" class="sourceSubSection">
		<h3>Dot Source</h3>

		<p>
			If rendering of the graph fails (i.e., you only see the dot source file) or you need the output in a different format, the dot source can also be rendered using the free desktop program <a href="http://www.graphviz.org/">Graphviz</a>, or rendered online at <a href="http://stamm-wilbrandt.de/GraphvizFiddle/">GraphvizFiddle</a>, <a href="http://www.webgraphviz.com">WebGraphviz</a>, or <a href="http://viz-js.com">Viz.js</a>.
		</p>

		<button type="button" id="editButton">Redraw with edits</button>
	
		<textarea id="dotfile"></textarea>
	</section>

	<section id="jsonSection" class="sourceSubSection">
		<h3>JSON Source</h3>

		<p>
			JSON output is useful for making <a href="https://dagrejs.github.io/project/dagre-d3/latest/demo/clusters.html">directed, clustered</a> graphs or <a href="https://lvngd.com/blog/force-directed-network-graph-d3/">force-directed graphs</a> using <a href="https://d3js.org">d3.js</a>.
		</p>

		<textarea id="jsonfile"></textarea>
	</section>

	<section id="gmlSection" class="sourceSubSection">
		<h3>GML Source</h3>

		<p>
			GML is a format similar to Dot that can be rendered by various free and open-source programs including <a href="https://cytoscape.org">Cytoscape</a>, <a href="https://gephi.org">Gephi</a>, <a href="https://networkx.github.io">NetworkX</a>, <a href="https://socnetv.org/">Social Network Visualizer</a>, and <a href="https://tulip.labri.fr/TulipDrupal/">Tulip</a>.  Note that it does not support clusters, and that other style data has been omitted because there is no standard way to format it.
		</p>

		<textarea id="gmlfile"></textarea>
	</section>

	<section id="graphmlSection" class="sourceSubSection">
		<h3>GraphML Source</h3>

		<p>
			GraphML is an XML-based graph format that can be rendered by various free and open-source programs including <a href="https://gephi.org">Gephi</a>, <a href="https://www.yworks.com/products/yed">yEd</a>, and <a href="https://www.yworks.com/yed-live/">yEd Live</a> (online).  Note that it does not support clusters, and that some other style data has been omitted.  Labels and colors are (somewhat) formatted for both yEd and other graphml readers.
		</p>

		<textarea id="graphmlfile"></textarea>
	</section>
	</section>

<script>(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var saveAs=saveAs||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,n=function(){return e.URL||e.webkitURL||e},o=t.createElementNS("http://www.w3.org/1999/xhtml","a"),r="download"in o,i=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},a=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),c=e.webkitRequestFileSystem,s=e.requestFileSystem||c||e.mozRequestFileSystem,d=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},f=0,u=function(e){var t=function(){"string"==typeof e?n().revokeObjectURL(e):e.remove()};setTimeout(t,4e4)},l=function(e,t,n){t=[].concat(t);for(var o=t.length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){d(e)}}},p=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["ï»¿",e],{type:e.type}):e},v=function(t,d,v){v||(t=p(t));var w,y,m,S=this,h=t.type,R=!1,O=function(){l(S,"writestart progress write writeend".split(" "))},g=function(){if(y&&a&&"undefined"!=typeof FileReader){var o=new FileReader;return o.onloadend=function(){var e=o.result;y.location.href="data:attachment/file"+e.slice(e.search(/[,;]/)),S.readyState=S.DONE,O()},o.readAsDataURL(t),void(S.readyState=S.INIT)}if(!R&&w||(w=n().createObjectURL(t)),y)y.location.href=w;else{void 0===e.open(w,"_blank")&&a&&(e.location.href=w)}S.readyState=S.DONE,O(),u(w)},b=function(e){return function(){if(S.readyState!==S.DONE)return e.apply(this,arguments)}},E={create:!0,exclusive:!1};return S.readyState=S.INIT,d||(d="download"),r?(w=n().createObjectURL(t),void setTimeout(function(){o.href=w,o.download=d,i(o),O(),u(w),S.readyState=S.DONE})):(e.chrome&&h&&"application/octet-stream"!==h&&(m=t.slice||t.webkitSlice,t=m.call(t,0,t.size,"application/octet-stream"),R=!0),c&&"download"!==d&&(d+=".download"),("application/octet-stream"===h||c)&&(y=e),s?(f+=t.size,void s(e.TEMPORARY,f,b(function(e){e.root.getDirectory("saved",E,b(function(e){var n=function(){e.getFile(d,E,b(function(e){e.createWriter(b(function(n){n.onwriteend=function(t){y.location.href=e.toURL(),S.readyState=S.DONE,l(S,"writeend",t),u(e)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&g()},"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=S["on"+e]}),n.write(t),S.abort=function(){n.abort(),S.readyState=S.DONE},S.readyState=S.WRITING}),g)}),g)};e.getFile(d,{create:!1},b(function(e){e.remove(),n()}),b(function(e){e.code===e.NOT_FOUND_ERR?n():g()}))}),g)}),g)):void g())},w=v.prototype,y=function(e,t,n){return new v(e,t,n)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return n||(e=p(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(w.abort=function(){var e=this;e.readyState=e.DONE,l(e,"abort")},w.readyState=w.INIT=0,w.WRITING=1,w.DONE=2,w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null,y)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs});

},{}],2:[function(require,module,exports){
!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define("underscore",r):function(){var t=n._,e=r();n._=e,e.noConflict=function(){return n._=t,e}}()}(this,function(){function n(r){return r instanceof n?r:this instanceof n?void(this._wrapped=r):new n(r)}function r(n,r,t){if(void 0===r)return n;switch(null==t?3:t){case 1:return function(t){return n.call(r,t)};case 3:return function(t,e,u){return n.call(r,t,e,u)};case 4:return function(t,e,u,o){return n.call(r,t,e,u,o)}}return function(){return n.apply(r,arguments)}}function t(n,t,e){return null==n?In:Pr(n)?r(n,t,e):Sn(n)&&!Wr(n)?qn(n):Rn(n)}function e(n,r){return t(n,r,1/0)}function u(r,u,o){return n.iteratee!==e?n.iteratee(r,u):t(r,u,o)}function o(n,r){return r=null==r?n.length-1:+r,function(){for(var t=Math.max(arguments.length-r,0),e=Array(t),u=0;u<t;u++)e[u]=arguments[u+r];switch(r){case 0:return n.call(this,e);case 1:return n.call(this,arguments[0],e);case 2:return n.call(this,arguments[0],arguments[1],e)}var o=Array(r+1);for(u=0;u<r;u++)o[u]=arguments[u];return o[r]=e,n.apply(this,o)}}function i(n){if(!Sn(n))return{};if(tr)return tr(n);or.prototype=n;var r=new or;return or.prototype=null,r}function a(n){return function(r){return null==r?void 0:r[n]}}function f(n,r){return null!=n&&Zn.call(n,r)}function c(n,r){for(var t=r.length,e=0;e<t;e++){if(null==n)return;n=n[r[e]]}return t?n:void 0}function l(n){var r=fr(n);return"number"==typeof r&&r>=0&&r<=ar}function p(n,t,e){t=r(t,e);var u,o;if(l(n))for(u=0,o=n.length;u<o;u++)t(n[u],u,n);else{var i=en(n);for(u=0,o=i.length;u<o;u++)t(n[i[u]],i[u],n)}return n}function s(n,r,t){r=u(r,t);for(var e=!l(n)&&en(n),o=(e||n).length,i=Array(o),a=0;a<o;a++){var f=e?e[a]:a;i[a]=r(n[f],f,n)}return i}function h(n){var t=function(r,t,e,u){var o=!l(r)&&en(r),i=(o||r).length,a=n>0?0:i-1;for(u||(e=r[o?o[a]:a],a+=n);a>=0&&a<i;a+=n){var f=o?o[a]:a;e=t(e,r[f],f,r)}return e};return function(n,e,u,o){var i=arguments.length>=3;return t(n,r(e,o,4),u,i)}}function v(n,r,t){var e=l(n)?_r:sn,u=e(n,r,t);if(void 0!==u&&-1!==u)return n[u]}function y(n,r,t){var e=[];return r=u(r,t),p(n,function(n,t,u){r(n,t,u)&&e.push(n)}),e}function g(n,r,t){return y(n,Y(u(r)),t)}function d(n,r,t){r=u(r,t);for(var e=!l(n)&&en(n),o=(e||n).length,i=0;i<o;i++){var a=e?e[i]:i;if(!r(n[a],a,n))return!1}return!0}function m(n,r,t){r=u(r,t);for(var e=!l(n)&&en(n),o=(e||n).length,i=0;i<o;i++){var a=e?e[i]:i;if(r(n[a],a,n))return!0}return!1}function b(n,r,t,e){return l(n)||(n=on(n)),("number"!=typeof t||e)&&(t=0),xr(n,r,t)>=0}function j(n,r){return s(n,Rn(r))}function _(n,r){return y(n,qn(r))}function w(n,r){return v(n,qn(r))}function x(n,r,t){var e,o,i=-1/0,a=-1/0;if(null==r||"number"==typeof r&&"object"!=typeof n[0]&&null!=n){n=l(n)?n:on(n);for(var f=0,c=n.length;f<c;f++)null!=(e=n[f])&&e>i&&(i=e)}else r=u(r,t),p(n,function(n,t,e){((o=r(n,t,e))>a||o===-1/0&&i===-1/0)&&(i=n,a=o)});return i}function S(n,r,t){var e,o,i=1/0,a=1/0;if(null==r||"number"==typeof r&&"object"!=typeof n[0]&&null!=n){n=l(n)?n:on(n);for(var f=0,c=n.length;f<c;f++)null!=(e=n[f])&&e<i&&(i=e)}else r=u(r,t),p(n,function(n,t,e){((o=r(n,t,e))<a||o===1/0&&i===1/0)&&(i=n,a=o)});return i}function A(n){return O(n,1/0)}function O(n,r,t){if(null==r||t)return l(n)||(n=on(n)),n[Wn(n.length-1)];var e=l(n)?yn(n):on(n),u=fr(e);r=Math.max(Math.min(r,u),0);for(var o=u-1,i=0;i<r;i++){var a=Wn(i,o),f=e[i];e[i]=e[a],e[a]=f}return e.slice(0,r)}function M(n,r,t){var e=0;return r=u(r,t),j(s(n,function(n,t,u){return{value:n,index:e++,criteria:r(n,t,u)}}).sort(function(n,r){var t=n.criteria,e=r.criteria;if(t!==e){if(t>e||void 0===t)return 1;if(t<e||void 0===e)return-1}return n.index-r.index}),"value")}function E(n,r){return function(t,e,o){var i=r?[[],[]]:{};return e=u(e,o),p(t,function(r,u){var o=e(r,u,t);n(i,r,o)}),i}}function N(n){return n?Wr(n)?Xn.call(n):Kr(n)?n.match(yr):l(n)?s(n,In):on(n):[]}function k(n){return null==n?0:l(n)?n.length:en(n).length}function I(n,r,t){return null==n||n.length<1?null==r?void 0:[]:null==r||t?n[0]:T(n,n.length-r)}function T(n,r,t){return Xn.call(n,0,Math.max(0,n.length-(null==r||t?1:r)))}function B(n,r,t){return null==n||n.length<1?null==r?void 0:[]:null==r||t?n[n.length-1]:R(n,Math.max(0,n.length-r))}function R(n,r,t){return Xn.call(n,null==r||t?1:r)}function F(n){return y(n,Boolean)}function q(n,r,t,e){e=e||[];for(var u=e.length,o=0,i=fr(n);o<i;o++){var a=n[o];if(l(a)&&(Wr(a)||zr(a)))if(r)for(var f=0,c=a.length;f<c;)e[u++]=a[f++];else q(a,r,t,e),u=e.length;else t||(e[u++]=a)}return e}function D(n,r){return q(n,r,!1)}function W(n,r,t,e){Mn(r)||(e=t,t=r,r=!1),null!=t&&(t=u(t,e));for(var o=[],i=[],a=0,f=fr(n);a<f;a++){var c=n[a],l=t?t(c,a,n):c;r&&!t?(a&&i===l||o.push(c),i=l):t?b(i,l)||(i.push(l),o.push(c)):b(o,c)||o.push(c)}return o}function z(n){for(var r=[],t=arguments.length,e=0,u=fr(n);e<u;e++){var o=n[e];if(!b(r,o)){var i;for(i=1;i<t&&b(arguments[i],o);i++);i===t&&r.push(o)}}return r}function P(n){for(var r=n&&x(n,fr).length||0,t=Array(r),e=0;e<r;e++)t[e]=j(n,e);return t}function K(n,r){for(var t={},e=0,u=fr(n);e<u;e++)r?t[n[e]]=r[e]:t[n[e][0]]=n[e][1];return t}function L(n){return function(r,t,e){t=u(t,e);for(var o=fr(r),i=n>0?0:o-1;i>=0&&i<o;i+=n)if(t(r[i],i,r))return i;return-1}}function V(n,r,t,e){t=u(t,e,1);for(var o=t(r),i=0,a=fr(n);i<a;){var f=Math.floor((i+a)/2);t(n[f])<o?i=f+1:a=f}return i}function C(n,r,t){return function(e,u,o){var i=0,a=fr(e);if("number"==typeof o)n>0?i=o>=0?o:Math.max(o+a,i):a=o>=0?Math.min(o+1,a):o+a+1;else if(t&&o&&a)return o=t(e,u),e[o]===u?o:-1;if(u!==u)return o=r(Xn.call(e,i,a),On),o>=0?o+i:-1;for(o=n>0?i:a-1;o>=0&&o<a;o+=n)if(e[o]===u)return o;return-1}}function J(n,r,t){null==r&&(r=n||0,n=0),t||(t=r<n?-1:1);for(var e=Math.max(Math.ceil((r-n)/t),0),u=Array(e),o=0;o<e;o++,n+=t)u[o]=n;return u}function U(n,r){if(null==r||r<1)return[];for(var t=[],e=0,u=n.length;e<u;)t.push(Xn.call(n,e,e+=r));return t}function $(n,r,t,e,u){if(!(e instanceof r))return n.apply(t,u);var o=i(n.prototype),a=n.apply(o,u);return Sn(a)?a:o}function G(n,r){var t=function(e){var u=t.cache,o=""+(r?r.apply(this,arguments):e);return f(u,o)||(u[o]=n.apply(this,arguments)),u[o]};return t.cache={},t}function H(n,r,t){var e,u,o,i,a=0;t||(t={});var f=function(){a=!1===t.leading?0:Yr(),e=null,i=n.apply(u,o),e||(u=o=null)},c=function(){var c=Yr();a||!1!==t.leading||(a=c);var l=r-(c-a);return u=this,o=arguments,l<=0||l>r?(e&&(clearTimeout(e),e=null),a=c,i=n.apply(u,o),e||(u=o=null)):e||!1===t.trailing||(e=setTimeout(f,l)),i};return c.cancel=function(){clearTimeout(e),a=0,e=u=o=null},c}function Q(n,r,t){var e,u,i=function(r,t){e=null,t&&(u=n.apply(r,t))},a=o(function(o){if(e&&clearTimeout(e),t){var a=!e;e=setTimeout(i,r),a&&(u=n.apply(this,o))}else e=Er(i,r,this,o);return u});return a.cancel=function(){clearTimeout(e),e=null},a}function X(n,r){return Or(r,n)}function Y(n){return function(){return!n.apply(this,arguments)}}function Z(){var n=arguments,r=n.length-1;return function(){for(var t=r,e=n[r].apply(this,arguments);t--;)e=n[t].call(this,e);return e}}function nn(n,r){return function(){if(--n<1)return r.apply(this,arguments)}}function rn(n,r){var t;return function(){return--n>0&&(t=r.apply(this,arguments)),n<=1&&(r=null),t}}function tn(n,r){var t=Tr.length,e=n.constructor,u=Pr(e)&&e.prototype||Gn,o="constructor";for(f(n,o)&&!b(r,o)&&r.push(o);t--;)(o=Tr[t])in n&&n[o]!==u[o]&&!b(r,o)&&r.push(o)}function en(n){if(!Sn(n))return[];if(rr)return rr(n);var r=[];for(var t in n)f(n,t)&&r.push(t);return Ir&&tn(n,r),r}function un(n){if(!Sn(n))return[];var r=[];for(var t in n)r.push(t);return Ir&&tn(n,r),r}function on(n){for(var r=en(n),t=r.length,e=Array(t),u=0;u<t;u++)e[u]=n[r[u]];return e}function an(n,r,t){r=u(r,t);for(var e=en(n),o=e.length,i={},a=0;a<o;a++){var f=e[a];i[f]=r(n[f],f,n)}return i}function fn(n){for(var r=en(n),t=r.length,e=Array(t),u=0;u<t;u++)e[u]=[r[u],n[r[u]]];return e}function cn(n){for(var r={},t=en(n),e=0,u=t.length;e<u;e++)r[n[t[e]]]=t[e];return r}function ln(n){var r=[];for(var t in n)Pr(n[t])&&r.push(t);return r.sort()}function pn(n,r){return function(t){var e=arguments.length;if(r&&(t=Object(t)),e<2||null==t)return t;for(var u=1;u<e;u++)for(var o=arguments[u],i=n(o),a=i.length,f=0;f<a;f++){var c=i[f];r&&void 0!==t[c]||(t[c]=o[c])}return t}}function sn(n,r,t){r=u(r,t);for(var e,o=en(n),i=0,a=o.length;i<a;i++)if(e=o[i],r(n[e],e,n))return e}function hn(n,r,t){return r in t}function vn(n,r){var t=i(n);return r&&Rr(t,r),t}function yn(n){return Sn(n)?Wr(n)?n.slice():Br({},n):n}function gn(n,r){return r(n),n}function dn(n,r){var t=en(r),e=t.length;if(null==n)return!e;for(var u=Object(n),o=0;o<e;o++){var i=t[o];if(r[i]!==u[i]||!(i in u))return!1}return!0}function mn(n,r,t,e){if(n===r)return 0!==n||1/n==1/r;if(null==n||null==r)return!1;if(n!==n)return r!==r;var u=typeof n;return("function"===u||"object"===u||"object"==typeof r)&&bn(n,r,t,e)}function bn(r,t,e,u){r instanceof n&&(r=r._wrapped),t instanceof n&&(t=t._wrapped);var o=Yn.call(r);if(o!==Yn.call(t))return!1;switch(o){case"[object RegExp]":case"[object String]":return""+r==""+t;case"[object Number]":return+r!=+r?+t!=+t:0==+r?1/+r==1/t:+r==+t;case"[object Date]":case"[object Boolean]":return+r==+t;case"[object Symbol]":return Hn.valueOf.call(r)===Hn.valueOf.call(t)}var i="[object Array]"===o;if(!i){if("object"!=typeof r||"object"!=typeof t)return!1;var a=r.constructor,c=t.constructor;if(a!==c&&!(Pr(a)&&a instanceof a&&Pr(c)&&c instanceof c)&&"constructor"in r&&"constructor"in t)return!1}e=e||[],u=u||[];for(var l=e.length;l--;)if(e[l]===r)return u[l]===t;if(e.push(r),u.push(t),i){if((l=r.length)!==t.length)return!1;for(;l--;)if(!mn(r[l],t[l],e,u))return!1}else{var p,s=en(r);if(l=s.length,en(t).length!==l)return!1;for(;l--;)if(p=s[l],!f(t,p)||!mn(r[p],t[p],e,u))return!1}return e.pop(),u.pop(),!0}function jn(n,r){return mn(n,r)}function _n(n){return null==n||(l(n)&&(Wr(n)||Kr(n)||zr(n))?0===n.length:0===en(n).length)}function wn(n){return!(!n||1!==n.nodeType)}function xn(n){return function(r){return Yn.call(r)==="[object "+n+"]"}}function Sn(n){var r=typeof n;return"function"===r||"object"===r&&!!n}function An(n){return!Ur(n)&&ur(n)&&!er(parseFloat(n))}function On(n){return Lr(n)&&er(n)}function Mn(n){return!0===n||!1===n||"[object Boolean]"===Yn.call(n)}function En(n){return null===n}function Nn(n){return void 0===n}function kn(n,r){if(!Wr(r))return f(n,r);for(var t=r.length,e=0;e<t;e++){var u=r[e];if(null==n||!Zn.call(n,u))return!1;n=n[u]}return!!t}function In(n){return n}function Tn(n){return function(){return n}}function Bn(){}function Rn(n){return Wr(n)?function(r){return c(r,n)}:a(n)}function Fn(n){return null==n?function(){}:function(r){return Wr(r)?c(n,r):n[r]}}function qn(n){return n=Rr({},n),function(r){return dn(r,n)}}function Dn(n,t,e){var u=Array(Math.max(0,n));t=r(t,e,1);for(var o=0;o<n;o++)u[o]=t(o);return u}function Wn(n,r){return null==r&&(r=n,n=0),n+Math.floor(Math.random()*(r-n+1))}function zn(n){var r=function(r){return n[r]},t="(?:"+en(n).join("|")+")",e=RegExp(t),u=RegExp(t,"g");return function(n){return n=null==n?"":""+n,e.test(n)?n.replace(u,r):n}}function Pn(n,r,t){Wr(r)||(r=[r]);var e=r.length;if(!e)return Pr(t)?t.call(n):t;for(var u=0;u<e;u++){var o=null==n?void 0:n[r[u]];void 0===o&&(o=t,u=e),n=Pr(o)?o.call(n):o}return n}function Kn(n){var r=++et+"";return n?n+r:r}function Ln(r,t,e){!t&&e&&(t=e),t=Dr({},t,n.templateSettings);var u=RegExp([(t.escape||ot).source,(t.interpolate||ot).source,(t.evaluate||ot).source].join("|")+"|$","g"),o=0,i="__p+='";r.replace(u,function(n,t,e,u,a){return i+=r.slice(o,a).replace(at,ft),o=a+n.length,t?i+="'+\n((__t=("+t+"))==null?'':_.escape(__t))+\n'":e?i+="'+\n((__t=("+e+"))==null?'':__t)+\n'":u&&(i+="';\n"+u+"\n__p+='"),n}),i+="';\n",t.variable||(i="with(obj||{}){\n"+i+"}\n"),i="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+i+"return __p;\n";var a;try{a=new Function(t.variable||"obj","_",i)}catch(n){throw n.source=i,n}var f=function(r){return a.call(this,r,n)};return f.source="function("+(t.variable||"obj")+"){\n"+i+"}",f}function Vn(r){var t=n(r);return t._chain=!0,t}function Cn(r,t){return r._chain?n(t).chain():t}function Jn(r){return p(ln(r),function(t){var e=n[t]=r[t];n.prototype[t]=function(){var r=[this._wrapped];return Qn.apply(r,arguments),Cn(this,e.apply(n,r))}}),n}var Un="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},$n=Array.prototype,Gn=Object.prototype,Hn="undefined"!=typeof Symbol?Symbol.prototype:null,Qn=$n.push,Xn=$n.slice,Yn=Gn.toString,Zn=Gn.hasOwnProperty,nr=Array.isArray,rr=Object.keys,tr=Object.create,er=Un.isNaN,ur=Un.isFinite,or=function(){},ir=n.VERSION="1.10.2";n.iteratee=e;var ar=Math.pow(2,53)-1,fr=a("length"),cr=h(1),lr=h(-1),pr=o(function(n,r,t){var e,u;return Pr(r)?u=r:Wr(r)&&(e=r.slice(0,-1),r=r[r.length-1]),s(n,function(n){var o=u;if(!o){if(e&&e.length&&(n=c(n,e)),null==n)return;o=n[r]}return null==o?o:o.apply(n,t)})}),sr=E(function(n,r,t){f(n,t)?n[t].push(r):n[t]=[r]}),hr=E(function(n,r,t){n[t]=r}),vr=E(function(n,r,t){f(n,t)?n[t]++:n[t]=1}),yr=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g,gr=E(function(n,r,t){n[t?0:1].push(r)},!0),dr=o(function(n,r){return br(n,r)}),mr=o(function(n){return W(q(n,!0,!0))}),br=o(function(n,r){return r=q(r,!0,!0),y(n,function(n){return!b(r,n)})}),jr=o(P),_r=L(1),wr=L(-1),xr=C(1,_r,V),Sr=C(-1,wr),Ar=o(function(n,r,t){if(!Pr(n))throw new TypeError("Bind must be called on a function");var e=o(function(u){return $(n,e,r,this,t.concat(u))});return e}),Or=o(function(n,r){var t=Or.placeholder,e=function(){for(var u=0,o=r.length,i=Array(o),a=0;a<o;a++)i[a]=r[a]===t?arguments[u++]:r[a];for(;u<arguments.length;)i.push(arguments[u++]);return $(n,e,this,this,i)};return e});Or.placeholder=n;var Mr=o(function(n,r){r=q(r,!1,!1);var t=r.length;if(t<1)throw new Error("bindAll must be passed function names");for(;t--;){var e=r[t];n[e]=Ar(n[e],n)}}),Er=o(function(n,r,t){return setTimeout(function(){return n.apply(null,t)},r)}),Nr=Or(Er,n,1),kr=Or(rn,2),Ir=!{toString:null}.propertyIsEnumerable("toString"),Tr=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],Br=pn(un),Rr=pn(en),Fr=o(function(n,t){var e={},u=t[0];if(null==n)return e;Pr(u)?(t.length>1&&(u=r(u,t[1])),t=un(n)):(u=hn,t=q(t,!1,!1),n=Object(n));for(var o=0,i=t.length;o<i;o++){var a=t[o],f=n[a];u(f,a,n)&&(e[a]=f)}return e}),qr=o(function(n,r){var t,e=r[0];return Pr(e)?(e=Y(e),r.length>1&&(t=r[1])):(r=s(q(r,!1,!1),String),e=function(n,t){return!b(r,t)}),Fr(n,e,t)}),Dr=pn(un,!0),Wr=nr||xn("Array"),zr=xn("Arguments"),Pr=xn("Function"),Kr=xn("String"),Lr=xn("Number"),Vr=xn("Date"),Cr=xn("RegExp"),Jr=xn("Error"),Ur=xn("Symbol"),$r=xn("Map"),Gr=xn("WeakMap"),Hr=xn("Set"),Qr=xn("WeakSet");!function(){zr(arguments)||(zr=function(n){return f(n,"callee")})}();var Xr=Un.document&&Un.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof Xr&&(Pr=function(n){return"function"==typeof n||!1});var Yr=Date.now||function(){return(new Date).getTime()},Zr={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},nt=cn(Zr),rt=zn(Zr),tt=zn(nt),et=0,ut=n.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},ot=/(.)^/,it={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},at=/\\|'|\r|\n|\u2028|\u2029/g,ft=function(n){return"\\"+it[n]};p(["pop","push","reverse","shift","sort","splice","unshift"],function(r){var t=$n[r];n.prototype[r]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!==r&&"splice"!==r||0!==n.length||delete n[0],Cn(this,n)}}),p(["concat","join","slice"],function(r){var t=$n[r];n.prototype[r]=function(){return Cn(this,t.apply(this._wrapped,arguments))}}),n.prototype.value=function(){return this._wrapped},n.prototype.valueOf=n.prototype.toJSON=n.prototype.value,n.prototype.toString=function(){return String(this._wrapped)};var ct={default:n,VERSION:ir,iteratee:e,restArguments:o,each:p,forEach:p,map:s,collect:s,reduce:cr,foldl:cr,inject:cr,reduceRight:lr,foldr:lr,find:v,detect:v,filter:y,select:y,reject:g,every:d,all:d,some:m,any:m,contains:b,includes:b,include:b,invoke:pr,pluck:j,where:_,findWhere:w,max:x,min:S,shuffle:A,sample:O,sortBy:M,groupBy:sr,indexBy:hr,countBy:vr,toArray:N,size:k,partition:gr,first:I,head:I,take:I,initial:T,last:B,rest:R,tail:R,drop:R,compact:F,flatten:D,without:dr,uniq:W,unique:W,union:mr,intersection:z,difference:br,unzip:P,zip:jr,object:K,findIndex:_r,findLastIndex:wr,sortedIndex:V,indexOf:xr,lastIndexOf:Sr,range:J,chunk:U,bind:Ar,partial:Or,bindAll:Mr,memoize:G,delay:Er,defer:Nr,throttle:H,debounce:Q,wrap:X,negate:Y,compose:Z,after:nn,before:rn,once:kr,keys:en,allKeys:un,values:on,mapObject:an,pairs:fn,invert:cn,functions:ln,methods:ln,extend:Br,extendOwn:Rr,assign:Rr,findKey:sn,pick:Fr,omit:qr,defaults:Dr,create:vn,clone:yn,tap:gn,isMatch:dn,isEqual:jn,isEmpty:_n,isElement:wn,isArray:Wr,isObject:Sn,isArguments:zr,isFunction:Pr,isString:Kr,isNumber:Lr,isDate:Vr,isRegExp:Cr,isError:Jr,isSymbol:Ur,isMap:$r,isWeakMap:Gr,isSet:Hr,isWeakSet:Qr,isFinite:An,isNaN:On,isBoolean:Mn,isNull:En,isUndefined:Nn,has:kn,identity:In,constant:Tn,noop:Bn,property:Rn,propertyOf:Fn,matcher:qn,matches:qn,times:Dn,random:Wn,now:Yr,escape:rt,unescape:tt,result:Pn,uniqueId:Kn,templateSettings:ut,template:Ln,chain:Vn,mixin:Jn},lt=Jn(ct);return lt._=lt,lt});

},{}],3:[function(require,module,exports){
var filesaver=require("filesaver.js-npm"),_=require("underscore"),dotGraph={};!function(e){var t={checkpoint:!0,checkpointTag:"checkpoint",cluster:!1,clusterTags:[],color:"length",countWords:!0,display:!0,dotExtension:"gv",ends:!0,endTag:"end",engine:"dot",hideSource:!1,hideSettings:!1,increment:.2,lastTag:!1,omitSpecialPassages:!0,omitSpecialTags:!0,omitTags:[],prefix:"",postfix:"",renumber:!1,rotation:"TB",scale:"100%",showNodeNames:!1,showSettings:!1,showTagKey:"default",snowstick:!1,source:"dot",tooltips:!0,trace:"",palette:["#FEAF16","#2ED9FF","#DEA0FD","#FE00FA","#F7E1A0","#16FF32","#3283FE","#1C8356","#FBE426","#FA0087","#F8A19F","#1CBE4F","#C4451C","#C075A6","#90AD1C","#B00068","#AA0DFE","#FC1CBF","#1CFFCE","#F6222E","#85660D","#325A9B","#B10DA1","#A0A0A0","#782AB6","#565656"],paletteExceptions:{start:"#C8C8C8",ends:"#C8C8C8",unreachable:"#FF6666",untagged:"#FFFFFF",trace:"#FF8000",default:"#FFFFFF",leafHue:.3,readHue:.22}},n={},a=["StoryTitle","StoryIncludes","StoryData","StoryAuthor","StorySubtitle","StoryMenu","StorySettings","StoryColophon","StoryBanner","StoryCaption","StoryInit","StoryShare","PassageDone","PassageFooter","PassageHeader","PassageReady","MenuOptions","MenuShare","DotGraphSettings"],o=["annotation","debug-footer","debug-header","debug-startup","footer","haml","header","script","startup","stylesheet","twee2","transition","Twine.private","widget"],s={title:"Untitled",startNode:1,startNodeName:"Start",leaves:0,links:0,tightEnds:0,avLength:1,maxLength:1,passages:[],reachable:[],tags:[],tagObject:[],targets:{},twineVersion:0},r=new Viz;e.dot=function(){function n(){var e=[];return e.push("digraph "+h(s.title)+" {"),e.push("rankdir="+t.rotation+"\r\n"),t.cluster&&(e=e.concat(m(s.tagObject))),("tag"==t.color&&s.tags.length!=t.clusterTags.length&&"default"==t.showTagKey||"always"==t.showTagKey)&&(e=e.concat(f(s,t))),e=e.concat(g()),e.push('\r\nlabelloc="t"\r\n'),e.push("label="+h(s.title)),e.push("\r\n}"),e.join("\r\n")}function a(){var n=document.getElementById("dotfile").value;document.getElementById("graph").innerHTML="",r.renderSVGElement(n,{engine:t.engine}).then(function(n){n.setAttribute("id","graphviz"),document.getElementById("graph").appendChild(n),e.graph.scale(),t.snowstick&&document.querySelectorAll("#graph g.node text").forEach(function(t){t.addEventListener("click",e.settings.bookmark,!1)})}).catch(function(e){r=new Viz,console.log(e)})}function o(e){return s.targets.hasOwnProperty(e)?s.targets[e]:h(e)}function i(e,n,a,o){var s;return s=(n?!t.showNodeNames:t.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",a&&t.countWords&&(s+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(s=t.prefix+s+t.postfix),h(s)}function l(e){return t.showNodeNames?h(e):o(e)}function c(e,n){for(var a=[],s=0;s<e.links.length;s++){var r=e.links[s][0],i=n+" -> "+(t.showNodeNames?h(r):o(r));e.links[s][1]&&(i+=" [style = dashed]"),a.push(i)}return a}function d(e,t,n){return e.toFixed(2)+","+t.toFixed(2)+","+n.toFixed(2)}function g(){var e=[];if(t.renumber&&!t.showNodeNames){var n;for(n=0;n<s.passages.length;++n)s.passages[n].pid==s.startNode&&(e=e.concat(u(s.passages[n],1)));var a=2;for(n=0;n<s.passages.length;++n){var o=s.passages[n];o.pid==s.startNode||t.omitSpecialPassages&&o.special||o.omit||(e=e.concat(u(o,a)),a++)}}else for(n=0;n<s.passages.length;++n)s.passages[n].omit||(e=e.concat(u(s.passages[n])));return e}function u(e,n){var a=[];if(t.omitSpecialPassages&&e.special||e.omit)return a;var o=i(e),s=p(e,n),r=c(e,o);return a.push("\r\n"+o+" ["+s.join(" ")+"]"),a=a.concat(r)}function p(n,a){var o=[],r=0,l=0,c=1,g=n.pid,u=(n.content,n.theTag);if(t.snowstick&&n.ssBookmark?o.push("shape=note"):n.trace?o.push("shape=hexagon"):g==s.startNode||_.find(s.unreachable,function(e){return e==n.name})?o.push("shape=doublecircle"):t.ends&&e.passage.hasTag(n,t.endTag)?o.push("shape=egg"):t.checkpoints&&e.passage.hasTag(n,t.checkpointTag)&&o.push("shape=diamond"),0===o.length&&0===n.links.length&&t.ends?o.push('style="filled,diagonals"'):o.length?o.push('style="filled,bold"'):"bw"!=t.color&&o.push("style=filled"),"length"==t.color)r=Math.round(100*Math.min(1.75,n.textLength/s.avLength)/3)/100,o.push('fillcolor="'+r+',0.66,0.85"');else if("tag"==t.color&&u){var p=s.tags.indexOf(u);p>-1&&(r=t.palette[p%26]),o.push('fillcolor="'+r+'"'),o.push('fontcolor="'+t.paletteContrastColors[p%26]+'"')}else"tag"==t.color||(t.snowstick&&n.ssLeaf&&(t.ends&&e.passage.hasTag(n,t.endTag)||n.leaf)?(r=t.paletteExceptions.leafHue,o.push('fillcolor="'+d(r,.9,.5)+'"')):t.snowstick&&n.ssLeaf?(r=t.paletteExceptions.leafHue,l=n.ssLeaf,c=Math.round(100*n.ssLeaf/5)/100+.5,o.push('fillcolor="'+d(r,l,c)+'"')):n.trace?o.push('fillcolor="'+t.paletteExceptions.trace+'"'):t.snowstick&&n.ssRead?(r=t.paletteExceptions.readHue,l=n.ssRead,c=Math.round(100*n.ssRead/5)/100+.79,o.push('fillcolor="'+d(r,l,c)+'"')):g==s.startNode?o.push('fillcolor="'+t.paletteExceptions.start+'"'):t.ends&&e.passage.hasTag(n,t.endTag)?o.push('fillcolor="'+t.paletteExceptions.ends+'"'):_.find(s.unreachable,function(e){return e==n.name})?o.push('fillcolor="'+t.paletteExceptions.unreachable+'"'):"tag"==t.color?o.push('fillcolor="'+t.paletteExceptions.untagged+'"'):o.push('fillcolor="'+t.paletteExceptions.default+'"'));return(a||t.prefix||t.postfix)&&(a?o.push('label="'+t.prefix+a+t.postfix+'"'):o.push("label="+i(n,!1,!1,!0))),t.tooltips&&o.push("tooltip="+i(n,!0,!0)),o}function h(e){return e&&(e=e.toString().replace(/"/gm,'\\"'),e='"'+e+'"'),e}function m(n){var a=[],o=0;for(var s in n)n.hasOwnProperty(s)&&!e.settings.isOmittedTag(s)&&(0==t.clusterTags.length||t.clusterTags.indexOf(s)>-1)&&(a.push("subgraph cluster_"+o+" {"),a.push("label="+h(s)),a.push('style="rounded, filled" fillcolor="ivory"'),a.push(n[s].map(l).join(" \r\n")),a.push("}\r\n"),o++);return a}function f(t,n){var a=[];a.push("subgraph cluster_tagKey {"),a.push('label="Tags"'),a.push('style="rounded, filled" fillcolor="white"'),a.push("rank=same");for(var o,r,i=0;i<t.tags.length;i++)e.settings.isOmittedTag(s.tags[i])||(o=h(s.tags[i]),r="tagKeyNodeID_"+i,a.push(r+" [label="+o+' shape=rect style="filled,rounded" fillcolor="'+n.palette[i%26]+'" fontcolor="'+n.paletteContrastColors[i%26]+'"]'));a.push("}");var l=n.showNodeNames?h(t.startNodeName):t.startNode;for(i=0;i<t.tags.length;i++)e.settings.isOmittedTag(t.tags[i])||(r="tagKeyNodeID_"+i),a.push(r+" -> "+l+" [style=invis]");return a}return{convert:n,render:a}}(),e.gml=function(){function n(){var n=[],a=e.settings.ifid().replace(/[A-F\-]/g,"").substr(0,6);n.push("graph ["),n.push("directed 1"),n.push("id "+(a||s.passages.length+1800)),n.push("label "+d(s.title)),t.cluster,"tag"==t.color&&(s.tags.length,t.clusterTags.length);var o=i();return n=n.concat(o.nodes.join("")),n=n.concat(o.edges.join("\r\n")),n.push("\r\n]"),n.join("\r\n\t")}function a(e){return s.targets.hasOwnProperty(e)?s.targets[e]:d(e)}function o(e,n,a,o){var s;return s=(n?!t.showNodeNames:t.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",a&&t.countWords&&(s+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(s=t.prefix+s+t.postfix),d(s)}function r(e,t){for(var n=[],o=0;o<e.links.length;o++){var r=e.links[o][0],i=(e.pid!=s.startNode||o>0?"\t":"")+"edge [\r\n\t\tsource "+e.pid+"\r\n\t\ttarget "+a(r);e.links[o][1]&&(i+=" \r\n\t\tlabel display"),i+="\r\n\t]",n.push(i)}return n}function i(){var e,n={nodes:[],edges:[]};if(t.renumber&&!t.showNodeNames){var a;for(a=0;a<s.passages.length;++a)s.passages[a].pid==s.startNode&&(e=l(s.passages[a],1),n.nodes=n.nodes.concat(e.node),n.edges=n.edges.concat(e.edges));var o=2;for(a=0;a<s.passages.length;++a){var r=s.passages[a];r.pid==s.startNode||t.omitSpecialPassages&&r.special||r.omit||(e=l(r,o),n.nodes=n.nodes.concat(e.node),n.edges=n.edges.concat(e.edges),o++)}}else for(a=0;a<s.passages.length;++a)s.passages[a].omit||(e=l(s.passages[a]),n.nodes=n.nodes.concat(e.node),n.edges=n.edges.concat(e.edges));return n}function l(e,n){var a={node:[],edges:[]};if(t.omitSpecialPassages&&e.special||e.omit)return a;var i=[];e.pid!=s.startNode&&i.push("\t"),i.push("node ["),i.push("\tid "+e.pid),i.push("\tlabel "+c(e,n)),i.push("]"),a.node.push(i.join("\r\n\t"));var l=o(e);return a.edges=r(e,l),a}function c(e,n){return n=n||t.prefix||t.postfix?n?'"'+t.prefix+n+t.postfix+'"':o(e,!1,!1,!0):o(e)}function d(e){return e&&(e=e.toString().replace(/"/gm,'\\"'),e='"'+e+'"'),e}return{convert:n}}(),e.graphml=function(){function n(){var t=[],n=e.settings.ifid(),a='<?xml version="1.0" encoding="UTF-8"?>\r\n<graphml xmlns="http://graphml.graphdrawing.org/xmlns" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://graphml.graphdrawing.org/xmlns http://graphml.graphdrawing.org/xmlns/1.0/graphml.xsd" xmlns:y="http://www.yworks.com/xml/yfiles-common/3.0" xmlns:x="http://www.yworks.com/xml/yfiles-common/markup/3.0" xmlns:yjs="http://www.yworks.com/xml/yfiles-for-html/2.0/xaml">\r\n\t<key id="g4" for="node" attr.name="label"/>\r\n\t<key id="d4" for="node" attr.name="NodeLabels" y:attr.uri="http://www.yworks.com/xml/yfiles-common/2.0/NodeLabels"/>\r\n\t<key id="g7" for="node" attr.name="color"/>\r\n\t<key id="d7" for="node" attr.name="NodeStyle" y:attr.uri="http://www.yworks.com/xml/yfiles-common/2.0/NodeStyle"/>\r\n\t<graph id="'+(n||s.passages.length+1800)+'" edgedefault="directed">\r\n\t\t';return t.push("<desc>"+s.title+"</desc>"),t=t.concat(l()),a+t.join("\r\n\t\t")+"\r\n\t</graph>\r\n</graphml>\r\n"}function a(e){return s.targets.hasOwnProperty(e)?s.targets[e]:g(e)}function o(e,n,a,o){var s;return s=(n?!t.showNodeNames:t.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",a&&t.countWords&&(s+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(s=t.prefix+s+t.postfix),g(s)}function r(e,t){for(var n=[],o=0;o<e.links.length;o++){var s=e.links[o][0],r='<edge source="'+e.pid+'" target="'+a(s)+'">';e.links[o][1]&&(r+="<desc>display link</desc>"),r+="</edge>",n.push(r)}return n}function i(e,t,n){var a,o,s,r,i,l,c,d;switch(r=Math.floor(6*e),i=6*e-r,l=n*(1-t),c=n*(1-i*t),d=n*(1-(1-i)*t),r%6){case 0:a=n,o=d,s=l;break;case 1:a=c,o=n,s=l;break;case 2:a=l,o=n,s=d;break;case 3:a=l,o=c,s=n;break;case 4:a=d,o=l,s=n;break;case 5:a=n,o=l,s=c}return a=Math.round(255*a).toString(16),o=Math.round(255*o).toString(16),s=Math.round(255*s).toString(16),"#"+(1==a.length?"0":"")+a+(1==o.length?"0":"")+o+(1==s.length?"0":"")+s}function l(){var e=[];if(t.renumber&&!t.showNodeNames){var n;for(n=0;n<s.passages.length;++n)s.passages[n].pid==s.startNode&&(e=e.concat(c(s.passages[n],1)));var a=2;for(n=0;n<s.passages.length;++n){var o=s.passages[n];o.pid==s.startNode||t.omitSpecialPassages&&o.special||o.omit||(e=e.concat(c(o,a)),a++)}}else for(n=0;n<s.passages.length;++n)s.passages[n].omit||(e=e.concat(c(s.passages[n])));return e}function c(e,n){var a=[];if(t.omitSpecialPassages&&e.special||e.omit)return a;var s=o(e),i=d(e,n);a.push('<node id="'+e.pid+'">'),a=a.concat(i),a.push("</node>");var l=r(e,s);return a=a.concat(l)}function d(n,a){var r,l,c,d=[],g=0,u=0,p=1,h=n.pid,m=(n.content,n.theTag);if(r=t.snowstick&&n.ssBookmark?"TRAPEZ":n.trace?"HEXAGON":h==s.startNode||_.find(s.unreachable,function(e){return e==n.name})?"OCTAGON":t.ends&&e.passage.hasTag(n,t.endTag)?"ROUND_RECTANGLE":t.checkpoints&&e.passage.hasTag(n,t.checkpointTag)?"DIAMOND":"ELLIPSE",c="BLACK","length"==t.color)g=Math.round(100*Math.min(1.75,n.textLength/s.avLength)/3)/100,l=i(g,.66,.85);else if("tag"==t.color&&m){var f=s.tags.indexOf(m);f>-1&&(g=t.palette[f%26]),l=g,c=t.paletteContrastColors[f%26]}else"tag"==t.color||(t.snowstick&&n.ssLeaf&&(t.ends&&e.passage.hasTag(n,t.endTag)||n.leaf)?(g=t.paletteExceptions.leafHue,l=i(g,.9,.5)):t.snowstick&&n.ssLeaf?(g=t.paletteExceptions.leafHue,u=n.ssLeaf,p=Math.round(100*n.ssLeaf/5)/100+.5,l=i(g,u,p)):n.trace?l=t.paletteExceptions.trace:t.snowstick&&n.ssRead?(g=t.paletteExceptions.readHue,u=n.ssRead,p=Math.round(100*n.ssRead/5)/100+.79,l=i(g,u,p)):l=h==s.startNode?t.paletteExceptions.start:t.ends&&e.passage.hasTag(n,t.endTag)?t.paletteExceptions.ends:_.find(s.unreachable,function(e){return e==n.name})?t.paletteExceptions.unreachable:"tag"==t.color?t.paletteExceptions.untagged:t.paletteExceptions.default);return d.push('\t<data key="g7">'+l+"</data>"),d.push('\t<data key="d7">'),d.push('\t\t<yjs:ShapeNodeStyle fill="'+l+'" shape="'+r+'"/>'),d.push("\t</data>"),a=a||t.prefix||t.postfix?a?t.prefix+a+t.postfix:o(n,!1,!1,!0):o(n),d.push('\t<data key="g4">'+a+"</data>"),d.push('\t<data key="d4">'),d.push("\t\t<x:List>"),d.push('\t\t\t<y:Label LayoutParameter="{x:Static y:InteriorLabelModel.Center}">'),d.push("\t\t\t\t<y:Label.Text>"+a+"</y:Label.Text>"),d.push("\t\t\t\t<y:Label.Style>"),d.push('\t\t\t\t\t<yjs:DefaultLabelStyle horizontalTextAlignment="CENTER" textFill="'+c+'"/>'),d.push("\t\t\t\t</y:Label.Style>"),d.push("\t\t\t</y:Label>"),d.push("\t\t</x:List>"),d.push("\t</data>"),d}function g(e){return e&&(e=e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")),e}return{convert:n}}(),e.json=function(){function n(){var n=[];t.cluster&&(n=h(s.tagObject));var a=d(n);n.length>0&&(a.clusters=n),a.settings={title:p(s.title)};var o=e.settings.ifid();return o&&(a.settings.ifid=o),"dot"==t.engine&&(a.settings.rankdir=t.rotation),JSON.stringify(a,null,"\t")}function a(){var t=JSON.parse(document.getElementById("jsonfile").value);document.getElementById("graph").innerHTML="<svg></svg>";var n={};t.settings&&t.settings.rankdir&&(n.rankdir=t.settings.rankdir);var a,o,s=new dagreD3.graphlib.Graph({compound:!0}).setGraph(n).setDefaultEdgeLabel(function(){return{}});for(a=0;a<t.nodes.length;a++){o=t.nodes[a];var r={label:o.label?o.label:o.name};o.color&&(r.style="fill: "+o.color+(o.contrastColor?"; stroke-color:"+o.contrastColor:"")+(o.trace?";stroke-width: 3px":"")),o.shape&&(r.shape=o.shape),s.setNode(o.id,r)}if(t.clusters){for(var i=0;i<t.clusters.length;i++){var l=t.clusters[i];s.setNode(l.id,{label:l.name,clusterLabelPos:"top",style:"fill: "+l.color+(l.contrastColor?"; stroke-color:"+l.contrastColor:"")})}for(a=0;a<t.nodes.length;a++)o=t.nodes[a],o.cluster&&s.setParent(o.id,o.cluster)}for(var c=0;c<t.links.length;c++){var d=t.links[c],g={curve:d3.curveBasis};d.category&&"display"==d.category&&(g.style="stroke-dasharray: 5, 5;"),s.setEdge(d.source,d.target,g)}s.nodes().forEach(function(e){var t=s.node(e);t.rx=t.ry=5});var u=new dagreD3.render,p=d3.select("svg"),h=p.append("g");u(d3.select("svg g"),s),p.attr("id","dagre"),p.attr("width","100%"),isFinite(s.graph().width)&&isFinite(s.graph().height)&&(p.attr("viewBox","0 0 "+(s.graph().width+100)+" "+(s.graph().height+100)),h.attr("transform","scale(1 1) translate(50, 50)")),e.graph.scale()}function o(e,t){for(var n=0;n<e.length;n++){var a=e[n];if(t.hasOwnProperty(a))return t[a]}return null}function r(e){return s.targets.hasOwnProperty(e)?s.targets[e]:p(e)}function i(e,n,a,o){var s;return s=(n?!t.showNodeNames:t.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",a&&t.countWords&&(s+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(s=t.prefix+s+t.postfix),p(s)}function l(e,t){for(var n=[],a=0;a<e.links.length;a++){var o=e.links[a][0],s={source:e.pid,target:r(o)};e.links[a][1]&&(s.category="display"),n.push(s)}return n}function c(e,t,n){var a,o,s,r,i,l,c,d;switch(r=Math.floor(6*e),i=6*e-r,l=n*(1-t),c=n*(1-i*t),d=n*(1-(1-i)*t),r%6){case 0:a=n,o=d,s=l;break;case 1:a=c,o=n,s=l;break;case 2:a=l,o=n,s=d;break;case 3:a=l,o=c,s=n;break;case 4:a=d,o=l,s=n;break;case 5:a=n,o=l,s=c}return a=Math.round(255*a).toString(16),o=Math.round(255*o).toString(16),s=Math.round(255*s).toString(16),"#"+(1==a.length?"0":"")+a+(1==o.length?"0":"")+o+(1==s.length?"0":"")+s}function d(e){for(var n={nodes:[],links:[]},a={},o=0;o<e.length;o++){var r=e[o];a[r.name]=r.id}var i;if(t.renumber&&!t.showNodeNames){var l;for(l=0;l<s.passages.length;++l)s.passages[l].pid==s.startNode&&(i=g(s.passages[l],1,a),n.nodes=n.nodes.concat(i.node),n.links=n.links.concat(i.links));var c=2;for(l=0;l<s.passages.length;++l){var d=s.passages[l];d.pid==s.startNode||t.omitSpecialPassages&&d.special||d.omit||(i=g(d,c,a),n.nodes=n.nodes.concat(i.node),n.links=n.links.concat(i.links),c++)}}else for(l=0;l<s.passages.length;++l)s.passages[l].omit||(i=g(s.passages[l],null,a),n.nodes=n.nodes.concat(i.node),n.links=n.links.concat(i.links));return n}function g(e,n,a){var s={node:[],links:[]};if(t.omitSpecialPassages&&e.special||e.omit)return s;var r=i(e),c=u(e,n),d={id:e.pid,name:r};for(var g in c)c.hasOwnProperty(g)&&(d[g]=c[g]);if(t.cluster){var p=o(e.tagArray,a);p&&(d.cluster=p)}return s.node.push(d),s.links=l(e,r),s}function u(n,a){var o={},r=0,l=0,d=1,g=n.pid,u=(n.content,n.theTag);if(n.trace&&(o.trace=!0),t.snowstick&&n.ssBookmark?o.shape="rect":g==s.startNode||_.find(s.unreachable,function(e){return e==n.name})?o.shape="circle":t.ends&&e.passage.hasTag(n,t.endTag)?o.shape="rect":t.checkpoints&&e.passage.hasTag(n,t.checkpointTag)?o.shape="diamond":t.showNodeNames?o.shape="ellipse":o.shape="circle","length"==t.color)r=Math.round(100*Math.min(1.75,n.textLength/s.avLength)/3)/100,o.color=c(r,.66,.85);else if("tag"==t.color&&u){var p=s.tags.indexOf(u);p>-1&&(r=t.palette[p%26]),o.color=r,o.contrastColor=t.paletteContrastColors[p%26]}else"tag"==t.color||(t.snowstick&&n.ssLeaf&&(t.ends&&e.passage.hasTag(n,t.endTag)||n.leaf)?(r=t.paletteExceptions.leafHue,o.color=c(r,.9,.5)):t.snowstick&&n.ssLeaf?(r=t.paletteExceptions.leafHue,l=n.ssLeaf,d=Math.round(100*n.ssLeaf/5)/100+.5,o.color=c(r,l,d)):n.trace?o.color=t.paletteExceptions.trace:t.snowstick&&n.ssRead?(r=t.paletteExceptions.readHue,l=n.ssRead,d=Math.round(100*n.ssRead/5)/100+.79,o.color=c(r,l,d)):g==s.startNode?o.color=t.paletteExceptions.start:t.ends&&e.passage.hasTag(n,t.endTag)?o.color=t.paletteExceptions.ends:_.find(s.unreachable,function(e){return e==n.name})?o.color=t.paletteExceptions.unreachable:"tag"==t.color?o.color=t.paletteExceptions.untagged:o.color=t.paletteExceptions.default);return a||t.prefix||t.postfix?o.label=a?t.prefix+a+t.postfix:i(n,!1,!1,!0):o.label=i(n),o}function p(e){return e}function h(n){var a,o=[],s=0;for(var r in n)n.hasOwnProperty(r)&&!e.settings.isOmittedTag(r)&&(0==t.clusterTags.length||t.clusterTags.indexOf(r)>-1)&&(a={id:"c"+s,name:p(r),color:t.palette[s%26],contrastColor:t.paletteContrastColors[s%26]},o.push(a),s++);return o}return{convert:n,render:a}}(),e.graph=function(){function n(e){if("#"!=e.charAt(0)||(e.length-1)%3!=0)return"#000000";var t=[];return t=e.length-1==3?[e.charAt(1),e.charAt(2),e.charAt(3)]:[e.substring(1,3),e.substring(3,5),e.substring(5,7)],t=t.map(function(e){return parseInt(e,16)/255}),.299*t[0]+.587*t[1]+.114*t[2]>.5?"#000000":"#ffffff"}function a(n){e.settings.parse(n),e.story.parse();var a=e[t.source].convert();document.getElementById(t.source+"file").value=a,"json"!=t.source&&"dot"!=t.source&&(a=e.dot.convert(),document.getElementById("dotfile").value=a),o(n)}function o(n){"json"==t.source?e.json.render():e.dot.render()}function s(){var e=document.getElementById(t.source+"file").value,n=new Blob([e],{type:"text/plain;charset=utf-8"}),a=t.source;"dot"==a&&(a=t.dotExtension),filesaver.saveAs(n,t.source+Date.now()+"."+a,!0)}function r(){var e=document.getElementById("graph").firstChild.outerHTML,t=new Blob([e],{type:"image/svg+xml;charset=utf-8"});filesaver.saveAs(t,"dotgraph"+Date.now()+".svg",!0)}function i(e){var n=document.getElementsByTagName("svg")[0];if(n.removeAttribute("height"),t.scale){if(void 0!==e){var a=t.scale.split(/(\d+)/),o=a[a.length-1];t.scale=parseInt(parseInt(n.getAttribute("width"),10)*(1+e),10)+o}}else{var s=n.getAttribute("viewBox").split(" ");t.scale=void 0===e?s[2]+"pt":parseFloat(n.getAttribute("width"))+parseFloat(s[2])*e+"pt"}n.setAttribute("width",t.scale),document.getElementById("scaleInput").value=t.scale}return{contrastColor:n,convert:a,render:o,saveSource:s,saveSvg:r,scale:i}}(),e.init=function(){function n(){e.settings.load(),e.settings.write(),e.settings.source(),e.settings.toggle(),a(),window.location.search&&window.location.search.split("?")[1].length>0&&e.story.load(window.location.search.split("?")[1])}function a(){document.getElementById("settingsForm").addEventListener("click",e.graph.convert,!1),document.getElementById("clusterTags").addEventListener("input",_.debounce(e.graph.convert,1e3),!1),document.getElementById("omitTags").addEventListener("input",_.debounce(e.graph.convert,1e3),!1),document.getElementById("trace").addEventListener("input",_.debounce(e.graph.convert,1e3),!1),document.getElementById("editButton").addEventListener("click",e.graph.render,!1),document.getElementById("saveSourceButton").addEventListener("click",e.graph.saveSource,!1),document.getElementById("saveSvgButton").addEventListener("click",e.graph.saveSvg,!1),document.getElementById("sourceSelect").addEventListener("change",e.settings.source,!1),document.getElementById("scaleInput").addEventListener("change",function(){e.settings.scale()},!1),document.getElementById("scaleUpButton").addEventListener("click",function(){e.graph.scale(t.increment)},!1),document.getElementById("scaleDownButton").addEventListener("click",function(){e.graph.scale(-t.increment)},!1),document.getElementById("graphHeader").addEventListener("click",function(){e.settings.toggle("graphSection")},!1),document.getElementById("settingsHeader").addEventListener("click",function(){e.settings.toggle("settingsSection")},!1),document.getElementById("sourceHeader").addEventListener("click",function(){e.settings.toggle("sourceSection")},!1)}return{load:n}}(),e.passage=function(){function o(e,t){return e.tagArray.indexOf(t)>-1}function s(e,o){var s={},l=e.getAttribute("tags")?e.getAttribute("tags").trim().split(" "):[],d=c(e.innerText);return s.content=e.innerText,s.links=d,s.leaf=0===d.length,s.textLength=e.innerText.length,s.wordCount=e.innerText.trim()?e.innerText.trim().split(/\s+/).length:0,s.pid=e.getAttribute("pid")?e.getAttribute("pid"):o,s.tagArray=l,s.theTag=r(l),s.name=e.getAttribute("name")?e.getAttribute("name"):e.getAttribute("tiddler")?e.getAttribute("tiddler"):"Untitled Passage",s.special=a.indexOf(s.name)>-1,s.omit=i(s),s.trace=t.trace&&e.innerText.indexOf(t.trace)>-1,t.snowstick&&(s.ssLeaf=Math.max(n.leaf.indexOf(s.name),0)/Math.max(n.leaf.length,1),s.ssRead=Math.max(n.read.indexOf(s.name),0)/Math.max(n.read.length,1),s.ssBookmark=n.bookmark==s.name),s}function r(e){var n=e.slice(0);return t.ends&&n.indexOf(t.endTag)>-1&&n.splice(n.indexOf(t.endTag),1),t.checkpoints&&n.indexOf(t.checkpointTag)>-1&&n.splice(n.indexOf(t.checkpointTag),1),n.length&&t.lastTag?n[n.length-1]:n.length?n[0]:""}function i(n){if(0==t.omitTags.length&&0==t.omitSpecialTags)return!1;for(var a=0;a<n.tagArray.length;a++)if(e.settings.isOmittedTag(n.tagArray[a]))return!0;return!1}function l(e,t){var n=e.indexOf("|");if(-1!=n)e=e.substr(n+1);else{var a=e.indexOf("->");if(-1!=a)e=e.substr(a+2);else{var o=e.indexOf("<-");-1!=o&&(e=e.substr(0,o))}}return[e,t]}function c(e){var n,a,o,s=[],r=/\[\[(.*?)\]\]/g,i=/\<\<display \"(.*?)\"\>\>/g,c=/\(display: \"(.*?)\"\)/g;if(e){for(e=e.replace(/\/\*.*\*\//g,""),e=e.replace(/^\/\/.*(\r\n?|\n)/g,"");null!==(n=r.exec(e));)a=l(n[1],0),/^\w+:\/\/\/?\w/i.test(a)||s.push(a);if(t.display){for(;null!==(n=i.exec(e));)o=l(n[1],1),/^\w+:\/\/\/?\w/i.test(o)||s.push(o);for(;null!==(n=c.exec(e));)o=l(n[1],1),/^\w+:\/\/\/?\w/i.test(o)||s.push(o)}}return s}return{hasTag:o,parse:s}}(),e.settings=function(){function a(e){var a=e.target.innerHTML;if(t.showNodeNames&&a){var o=s()?"-"+s():"";try{localStorage.setItem("snowstick-bookmark"+o,a),n.bookmark=localStorage.getItem("snowstick-bookmark"+o)?localStorage.getItem("snowstick-bookmark"+o):""}catch(e){console.log("Bookmarking failed.")}}}function s(){return window.document.querySelector("tw-storydata")?window.document.querySelector("tw-storydata").getAttribute("ifid").toUpperCase():""}function r(e){return(0!=t.omitTags.length||0!=t.omitSpecialTags)&&(t.omitTags.indexOf(e)>-1||!!(t.omitSpecialTags&&o.indexOf(e)>-1))}function i(){try{var e=s()?"-"+s():"";n.read=localStorage.getItem("snowstick-read"+e)?JSON.parse(localStorage.getItem("snowstick-read"+e)):[],n.leaf=localStorage.getItem("snowstick-leaf"+e)?JSON.parse(localStorage.getItem("snowstick-leaf"+e)):[],n.bookmark=localStorage.getItem("snowstick-bookmark"+e)?localStorage.getItem("snowstick-bookmark"+e):"",t.snowstick=n.leaf.length>0||n.read.length>0||n.bookmark.length>0}catch(e){t.snowstick=!1,console.log("Error checking local storage for SnowStick data: "+e.description)}var a;if(a=window.document.getElementById("storeArea")?window.document.getElementById("storeArea").querySelector('div[tiddler="DotGraphSettings"]'):window.document.querySelector('tw-passagedata[name="DotGraphSettings"]'))r=a.innerText;else{var o,r;(o=window.document.getElementById("storeArea")?window.document.getElementById("storeArea").querySelector('div[tiddler="StorySettings"]'):window.document.querySelector('tw-passagedata[name="StorySettings"]'))&&o.innerText&&o.innerText.indexOf("dotgraph:")>-1&&(r=o.innerText.split("dotgraph:")[1].split("\n")[0])}if(r)try{r=JSON.parse(r),document.getElementById("storySettingsTextarea").value="::DotGraphSettings\r\n\r\n"+JSON.stringify(r,null,"\t")+"\r\n"}catch(e){console.log("Found but couldn't parse dotgraph settings from story: "+r)}else try{(r=localStorage.getItem("dotgraph-settings"+(s()?"-"+s():"")))&&(r=JSON.parse(r))}catch(e){console.log("Check of local storage for settings failed.")}_.each(r,function(e,n){"snowstick"==n&&e||(t[n]=e)}),p(),t.showSettings&&(document.getElementById("notesDiv").remove(),document.getElementById("settingsDisplayDiv").style.display="block",m())}function l(e){t.checkpoints=!!document.getElementById("checkpointsCheckbox")&&document.getElementById("checkpointsCheckbox").checked,t.cluster=!!document.getElementById("clusterCheckbox")&&document.getElementById("clusterCheckbox").checked,t.clusterTags=document.getElementById("clusterTags")?f(document.getElementById("clusterTags").value):[],t.color=document.querySelector("input[name='colorCheckbox']:checked")?document.querySelector("input[name='colorCheckbox']:checked").value:"length",t.display=!document.getElementById("displayCheckbox")||document.getElementById("displayCheckbox").checked,t.ends=!!document.getElementById("endsCheckbox")&&document.getElementById("endsCheckbox").checked,t.engine=document.querySelector("input[name='engineCheckbox']:checked")?document.querySelector("input[name='engineCheckbox']:checked").value:"dot",t.omitSpecialPassages=!!document.getElementById("specialCheckbox")&&document.getElementById("specialCheckbox").checked,t.omitSpecialTags=!!document.getElementById("specialTagCheckbox")&&document.getElementById("specialTagCheckbox").checked,t.renumber=!!document.getElementById("renumberCheckbox")&&document.getElementById("renumberCheckbox").checked,t.rotation=document.querySelector("input[name='rotateCheckbox']:checked")?document.querySelector("input[name='rotateCheckbox']:checked").value:"TB",t.scale=document.getElementById("scaleInput")?document.getElementById("scaleInput").value:"",t.showNodeNames=!!document.getElementById("nodeCheckbox0")&&document.getElementById("nodeCheckbox0").checked,t.source=document.getElementById("sourceSelect").value,t.omitTags=document.getElementById("omitTags")?f(document.getElementById("omitTags").value):[],t.lastTag=!!document.getElementById("lastTagCheckbox")&&document.getElementById("lastTagCheckbox").checked,t.countWords=!!document.getElementById("wcCheckbox")&&document.getElementById("wcCheckbox").checked,t.trace=document.getElementById("trace")?b(document.getElementById("trace").value):"",e&&h()}function c(){t.scale=document.getElementById("scaleInput")?document.getElementById("scaleInput").value:"",e.graph.scale()}function d(n){t.source=document.getElementById("sourceSelect").value,document.querySelectorAll("section.sourceSubSection").forEach(function(e){e.style.display="none"}),document.getElementById(t.source+"Section").style.display="block",e.graph.convert(n),n&&h()}function g(e){e?document.getElementById(e).style.display=document.getElementById(e).offsetParent?"none":"":(t.hideGraph&&(document.getElementById("graphSection").style.display="none"),t.hideSettings&&(document.getElementById("settingsSection").style.display="none"),t.hideSource&&(document.getElementById("sourceSection").style.display="none"))}function u(){
var e=_.template('<input type="radio" id="nodeCheckbox0" name="nodeCheckbox" value="names" <%= (showNodeNames ? "checked" : "") %>/><label for="nodeCheckbox">&nbsp;Passage titles</label> \t\t\t<input type="radio" id="nodeCheckbox1" name="nodeCheckbox" value="pid"  <%= (showNodeNames ? "" : "checked") %> /><label for="nodeCheckbox">&nbsp;Passage ids (hover for title)</label> \t\t\t<input type="checkbox" id="renumberCheckbox" name="renumberCheckbox" <%= (renumber ? "checked" : "") %>/><label for="renumberCheckbox">&nbsp;renumber from 1</label><br /> \t\t\t<input type="radio" id="colorCheckbox0" name="colorCheckbox" value="bw" <%= (color == "bw" ? "checked" : "")%> />&nbsp;<label for="colorCheckbox0">Black & white</label> \t\t\t<input type="radio" id="colorCheckbox1" name="colorCheckbox" value="length" <%= (color == "length" ? "checked" : "")%> />&nbsp;<label for="colorCheckbox1">Color by node length</label> \t\t\t<input type="radio" id="colorCheckbox2" name="colorCheckbox" value="tag" <%= (color == "tag" ? "checked" : "")%>/>&nbsp;<label for="colorCheckbox2">Color by tag</label> '+(t.snowstick?'<input type="radio" id="colorCheckbox3" name="colorCheckbox" value="snow" <%= (color == "snow" ? "checked" : "")%>/>&nbsp;<label for="colorCheckbox3" title="SnowStick">Color by read state</label>':"")+'<br/> \t\t\t<input type="checkbox" id="displayCheckbox" name="displayCheckbox" checked/>&nbsp;<label for="displayCheckbox">Include display macro links</label> \t\t\t<input type="checkbox" id="wcCheckbox" name="wcCheckbox" <%= (countWords ? "checked" : "") %> />&nbsp;<label for="wcCheckbox">Include word counts (hover)</label><br/> \t\t\t<input type="checkbox" id="specialCheckbox" <%= (omitSpecialPassages ? "checked" : "") %> />&nbsp;<label for="specialCheckbox">Omit&nbsp;special&nbsp;passages</label> (StoryTitle,&nbsp;etc.) \t\t\t<input type="checkbox" id="specialTagCheckbox" <%= (omitSpecialTags ? "checked" : "") %> />&nbsp;<label for="specialTagCheckbox">Omit&nbsp;by&nbsp;special&nbsp;tags</label> (script,&nbsp;etc.)<br/> \t\t\t<input type="radio" id="omitTagsFakeRadioButton" disabled/>&nbsp;<label for="omitTags">Omit by tag(s):</label>&nbsp;<input type="text" id="omitTags" placeholder="Separate tags with commas." value="<%=omitTags.join(", ")%>"/><br/> \t\t\t<input type="checkbox" id="checkpointsCheckbox" <%= (checkpoint ? "checked" : "") %> />&nbsp;<label for="checkpointsCheckbox" title="This changes the shape of checkpoint passages to a diamond.">Detect checkpoint tags</label> \t\t\t<input type="checkbox" id="endsCheckbox" <%= (ends == true ? "checked" : "") %>/>&nbsp;<label for="endsCheckbox" title="This changes the shape of end passages to an egg and puts diagonals on loose ends and disconnected nodes.">Detect end tags</label> \t\t\t<input type="checkbox" id="lastTagCheckbox" <%= (lastTag ? "checked" : "") %> />&nbsp;<label for="lastTagCheckbox" title="The cluster and color by tag options normally use the first tag on each passage.">Use last tag</label><br/> \t\t\t<input type="checkbox" id="clusterCheckbox" <%= (cluster ? "checked" : "") %> />&nbsp;<label for="clusterCheckbox">Cluster by tags:</label>&nbsp;<input type="text" id="clusterTags" placeholder="Separate tags with commas; leave blank for all tags." value="<%=clusterTags.join(", ")%>"/><br/> \t\t\t<input type="radio" id="traceFakeRadioButton" disabled/>&nbsp;<label for="trace" title="Traced nodes are hex-shaped.">Trace phrase:</label>&nbsp;<input type="input" id="trace" value="<%=trace%>" /> <br/> \t\t\t<input type="radio" id="engineCheckbox0" name="engineCheckbox" value="circo" <%= (engine == "circo" ? "checked" : "")%> />&nbsp;<label for="engineCheckbox0">circo</label> \t\t\t<input type="radio" id="engineCheckbox1" name="engineCheckbox" value="dot" <%= (engine == "dot" ? "checked" : "")%> />&nbsp;<label for="engineCheckbox1">dot</label> \t\t\t(<input type="radio" id="rotateCheckbox0" name="rotateCheckbox" value="TB" <%= (rotation == "TB" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox0" title="Top to bottom">&darr;</label> \t\t\t<input type="radio" id="rotateCheckbox1" name="rotateCheckbox" value="LR" <%= (rotation == "LR" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox1" title="Left to right">&rarr;</label> \t\t\t<input type="radio" id="rotateCheckbox2" name="rotateCheckbox" value="BT" <%= (rotation == "BT" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox2" title="Bottom to top">&uarr;</label> \t\t\t<input type="radio" id="rotateCheckbox3" name="rotateCheckbox" value="RL" <%= (rotation == "RL" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox3" title="Right to left">&larr;</label>) \t\t\t<input type="radio" id="engineCheckbox2" name="engineCheckbox" value="fdp" <%= (engine == "fdp" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox2">fdp</label> \t\t\t<input type="radio" id="engineCheckbox3" name="engineCheckbox" value="neato" <%= (engine == "neato" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox3">neato</label> \t\t\t<input type="radio" id="engineCheckbox4" name="engineCheckbox" value="osage" <%= (engine == "osage" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox4">osage</label> \t\t\t<input type="radio" id="engineCheckbox5" name="engineCheckbox" value="twopi" <%= (engine == "twopi" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox5">twopi</label><br/>');document.getElementById("settingsForm").innerHTML=e(t),document.getElementById("scaleInput").value=t.scale,document.getElementById("sourceSelect").value=t.source}function p(){t.paletteContrastColors=t.palette.map(function(t){return e.graph.contrastColor(t)})}function h(){try{localStorage.setItem("dotgraph-settings"+(s()?"-"+s():""),JSON.stringify(t))}catch(e){console.log("Failed to save settings to local storage.")}m()}function m(){t.showSettings&&(document.getElementById("settingsTextarea").value="::DotGraphSettings\r\n\r\n"+JSON.stringify(t,null,"\t")+"\r\n")}function f(e){for(var t=e.trim().split(","),n=[],a=0;a<t.length;a++){var o=t[a].trim();""!=o&&n.push(o)}return document.getElementById("omitTagsFakeRadioButton").checked=n.length>0,n}function b(e){return e=e.trim(),document.getElementById("traceFakeRadioButton").checked=e.length>0,e}return{bookmark:a,ifid:s,isOmittedTag:r,load:i,parse:l,scale:c,source:d,toggle:g,write:u}}(),e.story=function(){function n(e,t){if(document.querySelector("tw-storydata, div#storeArea")&&document.querySelector("tw-storydata, div#storeArea").remove(),t||(document.getElementById("graph").innerHTML="<p style='text-align:center;'><i>Loading</i> <tt>"+e+"</tt> ...<span id='loadingResult' style='color:tomato;'></span><p>"),e){e=e.indexOf("t.co/")>0||e.indexOf("tads.org/")>0?"https://mcdemarco.net/games/bgg/proxy.php?csurl="+e:"https://cors-anywhere.herokuapp.com/"+e;var n=new XMLHttpRequest;n.onreadystatechange=a,n.open("GET",e),n.responseType="document",n.send()}}function a(){if(4!=this.readyState||200!=this.status&&304!=this.status)return void(document.getElementById("loadingResult").innerHTML=" not found.");var n=this.response.querySelector("tw-storydata, div#storeArea");if(!n){var a,o=this.response.url?this.response.url:this.responseURL?this.responseURL:"";if(this.response.querySelector("meta[http-equiv=refresh]")){var s=this.response.querySelector("meta[http-equiv=refresh]").getAttribute("content");s&&(a=s.split(";URL=")[1])}else o.indexOf("philome.la/")>-1&&o.indexOf("/play")<0?a=o+"/play":o.indexOf("itch.io")>0?(a=this.response.querySelector("iframe[src]")?this.response.querySelector("iframe[src]").getAttribute("src"):(new DOMParser).parseFromString(this.response.querySelector("div.iframe_placeholder").getAttribute("data-iframe"),"text/html").body.childNodes[0].getAttribute("src"),a.indexOf("http")<0&&(a="https:"+a)):o.indexOf("ifdb.tads.org")>0&&(a=this.response.querySelector("div#links-div a"))&&(a=a.getAttribute("href"));return void(a?e.story.load(a,!0):document.getElementById("loadingResult").innerHTML=" failed.")}document.querySelector("body").append(n),t.scale="",n.children&&n.children.length&&n.children.length<20?t.showNodeNames=!0:t.showNodeNames=!1,e.settings.write(),e.graph.convert()}function o(){var n,a,o=window.document.getElementById("storeArea"),l=window.document.getElementsByTagName("tw-storydata")[0];if(o){s.twineVersion=1;var c="Untitled Story";o.querySelectorAll('[tiddler="StoryTitle"]').length&&(c=o.querySelectorAll('[tiddler="StoryTitle"]')[0].innerText),s.title=c}else l?(s.twineVersion=2,s.title=l.getAttribute("name")?l.getAttribute("name"):"Untitled",s.startNode=l.getAttribute("startnode")?l.getAttribute("startnode"):1):(s.title="Story not found",s.startNode="");for(a=o?o.querySelectorAll("div[tiddler]"):document.querySelectorAll("tw-passagedata"),s.passages=r(a),s.leaves=0,s.links=0,s.tightEnds=0,s.tagObject={},s.tags=[],s.targets={},n=0;n<s.passages.length;n++){var d=s.passages[n];o&&"Start"==d.name&&(s.startNode=n),t.ends&&e.passage.hasTag(d,t.endTag)&&s.tightEnds++,d.pid==s.startNode&&(s.startNodeName=d.name,s.reachable.push(d.name)),d.theTag&&(s.tagObject.hasOwnProperty(d.theTag)||(s.tagObject[d.theTag]=[],s.tags.push(d.theTag)),s.tagObject[d.theTag].push(d.name)),s.targets[d.name]=d.pid,s.links+=d.links.length,s.reachable=s.reachable.concat(_.map(d.links,_.first)),!d.leaf||d.omit||d.special&&t.omitSpecialPassages||s.leaves++}s.unreachable=_.difference(s.reachable,_.uniq(s.reachable)),s.reachable=_.uniq(s.reachable),s.maxLength=s.passages.reduce(function(e,t){return Math.max(e,t.textLength)},1),s.avLength=s.passages.reduce(function(e,t){return e+t.textLength},0)/s.passages.length,i()}function r(t){for(var n=[],a=0;a<t.length;a++)n[a]=e.passage.parse(t[a],a);return n}function i(){if(document.getElementById("nodeCount").innerHTML=s.passages.length,t.omitSpecialPassages||t.omitTags.length>0){var e=s.passages.reduce(function(e,n){return e+(n.special&&t.omitSpecialPassages||n.omit?1:0)},0);document.getElementById("omitCount").innerHTML=" ("+(s.passages.length-e)+" included, "+e+" omitted, "+s.unreachable.length+" unreachable)"}if(document.getElementById("leafCount").innerHTML=s.leaves,t.ends){var n=s.leaves-s.tightEnds;document.getElementById("looseCount").innerHTML=" (including "+(n>0?n:0)+" loose end"+(1!=n?"s":"")+")"}else document.getElementById("looseCount").innerHTML="";document.getElementById("linkCount").innerHTML=s.links,document.getElementById("average").innerHTML=Math.round(s.links/Math.max(s.passages.length,1)*100)/100,document.getElementById("stats").setAttribute("title","Twine "+s.twineVersion)}return{load:n,parse:o}}()}(dotGraph),window.onload=dotGraph.init.load();
},{"filesaver.js-npm":1,"underscore":2}]},{},[3]);
</script>
</body>
</html>
