<!DOCTYPE html>
<html>
<head>
<title>
DotGraph as a Service (DotGraph)
</title>
<meta charset="utf-8">
<style>
 /* dot and settings */
 body {margin:3%;}
 tw-storydata {display:none;}
 #stats {font-style:italic;text-align:center;}
 input#omitTags, input#clusterTags {width:30%;}
 label {white-space:nowrap;}
 div#notes {max-width:50%;float:right;}
 div#notes p {font-size:smaller;margin-top: 0;}
 h2 {float:left;padding-right:3em;;text-decoration:underline;}
 section {clear:both;}
 section.sourceSubSection {display:none;}
 textarea {width: 100%; height:20em;}
 textarea.settings {height:16em; width:20em;}
 #graphSection {text-align:center;}
 #saveSvgButton {float:left;}
 #scaleInput {width:5em;}
 #scaleUpButton, #scaleDownButton {font-weight:bold;}
 /* dagre-d3 */
 svg#dagre .clusters rect {fill: #00ffd0;stroke: #999;stroke-width: 1.5px;}
 svg#dagre text {font-weight: 300;font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;font-size: 14px;}
 svg#dagre .node rect, svg#dagre .node circle, svg#dagre .node ellipse, svg#dagre .node diamond {stroke: #000;fill: #fff;stroke-width: 1.5px;}
 svg#dagre .edgePath path {stroke: #333;fill: #333;stroke-width: 1.5px;}
 svg#dagre .edgePath path.path {stroke: #333;fill: none;stroke-width: 1.5px;}
</style>
<script src="https://mcdemarco.net/tools/viz/viz.js" type="text/javascript"></script><script src="https://mcdemarco.net/tools/viz/full.render.js" type="text/javascript"></script>
<script src="https://mcdemarco.net/tools/viz/d3.v5.min.js" type="text/javascript"></script><script src="https://mcdemarco.net/tools/viz/dagre-d3.min.js" type="text/javascript"></script>
</head>
<body>
	<h1>DotGraph as a Service</h1>

	<div id="stats" title="Twine">
		<span id="nodeCount">0</span>&nbsp;nodes<span id="omitCount"></span>,
		<span id="leafCount">0</span>&nbsp;leaves<span id="looseCount"></span>,
		<span id="linkCount">0</span>&nbsp;links, and
		<span id="average">0</span>&nbsp;links&nbsp;per&nbsp;node.
	</div>

	<h2 id="settingsHeader">Settings</h2>
	<section id="settingsSection">
		<div id="notes">
			<div id="notesDiv">
							<p><b>Notes:</b> The start node is double-circled, as are any unreachable nodes.  When color by length is on, all real nodes are colored in shades of red (shorter than average) to blue (longer than average) based on the relative length of their contents.</p>
							<p>Stray or misplaced nodes can result from the omit tags setting, from duplicate passage names, scripted passage transitions, or other linking issues.</p>
							<p>The layout engine options change the graph style; some options are slower than the default ("dot").  The image format is SVG.</p>
							<p>Several output options are available for use in other graphing programs.  The JSON version also generates a graph using dagre-d3 instead of graphviz (online version only).  For more information, see <a href="http://mcdemarco.net/tools/scree/dotgraph/">the website</a> or <a href="https://github.com/mcdemarco/dotgraph/blob/master/README.md">the README</a>.</p>
			</div>
			<div id="settingsDisplayDiv" style="display:none;white-space:nowrap;">
							<div style="display:inline-block;">
											<b>Currently selected settings</b><br/>
											<textarea id="settingsTextarea" class="settings"></textarea>
							</div>
							<div style="display:inline-block;">
											<b>Settings found in story</b><br/>
											<textarea id="storySettingsTextarea" class="settings" placeholder="no settings"></textarea> 
							</div>
			</div>
		</div>
		<div>
						<form id="settingsForm">
						</form>
		</div>
	</section>

	<h2 id="graphHeader">Graph</h2>
	<section id="graphSection">
		<button type="button" id="saveSvgButton">Save Image</button>
		<label for="scaleCheckbox">Scale:</label>&nbsp;<input type="text" id="scaleInput" value="" />
		<button type="button" id="scaleDownButton">&ndash;</button>
		<button type="button" id="scaleUpButton">+</button>
		<div id="graph"></div>
		<hr style="clear:both;"/>
	</section>

	<h2 id="sourceHeader">Source</h2>
	<section id="sourceSection">
		<select id="sourceSelect">
			<option value="dot">dot</option>
			<option value="gml">GML</option>
			<option value="graphml">GraphML</option>
			<option value="json">JSON</option>
		</select>
		<button type="button" id="saveSourceButton">Save Source</button>

	<section id="dotSection" class="sourceSubSection">
		<h3>Dot Source</h3>

		<p>
			If rendering of the graph fails (i.e., you only see the dot source file) or you need the output in a different format, the dot source can also be rendered using the free desktop program <a href="http://www.graphviz.org/">Graphviz</a>, or rendered online at <a href="http://stamm-wilbrandt.de/GraphvizFiddle/">GraphvizFiddle</a>, <a href="http://www.webgraphviz.com">WebGraphviz</a>, or <a href="http://viz-js.com">Viz.js</a>.
		</p>

		<button type="button" id="editButton">Redraw with edits</button>
	
		<textarea id="dotfile"></textarea>
	</section>

	<section id="jsonSection" class="sourceSubSection">
		<h3>JSON Source</h3>

		<p>
			JSON output is useful for making <a href="https://dagrejs.github.io/project/dagre-d3/latest/demo/clusters.html">directed, clustered</a> graphs or <a href="https://lvngd.com/blog/force-directed-network-graph-d3/">force-directed graphs</a> using <a href="https://d3js.org">d3.js</a>.
		</p>

		<textarea id="jsonfile"></textarea>
	</section>

	<section id="gmlSection" class="sourceSubSection">
		<h3>GML Source</h3>

		<p>
			GML is a format similar to Dot that can be rendered by various free and open-source programs including <a href="https://cytoscape.org">Cytoscape</a>, <a href="https://gephi.org">Gephi</a>, <a href="https://networkx.github.io">NetworkX</a>, <a href="https://socnetv.org/">Social Network Visualizer</a>, and <a href="https://tulip.labri.fr/TulipDrupal/">Tulip</a>.  Note that it does not support clusters, and that other style data has been omitted because there is no standard way to format it.
		</p>

		<textarea id="gmlfile"></textarea>
	</section>

	<section id="graphmlSection" class="sourceSubSection">
		<h3>GraphML Source</h3>

		<p>
			GraphML is an XML-based graph format that can be rendered by various free and open-source programs including <a href="https://gephi.org">Gephi</a>, <a href="https://www.yworks.com/products/yed">yEd</a>, and <a href="https://www.yworks.com/yed-live/">yEd Live</a> (online).  Note that it does not support clusters, and that some other style data has been omitted.  Labels and colors are (somewhat) formatted for both yEd and other graphml readers.
		</p>

		<textarea id="graphmlfile"></textarea>
	</section>
	</section>

<script>(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
var saveAs=saveAs||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=function(){return e.URL||e.webkitURL||e},n=e.document.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in n,r=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),i=e.webkitRequestFileSystem,a=e.requestFileSystem||i||e.mozRequestFileSystem,c=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s=0,f=function(e){setTimeout(function(){"string"==typeof e?t().revokeObjectURL(e):e.remove()},4e4)},u=function(e,t,n){for(var o=(t=[].concat(t)).length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){c(e)}}},d=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["ï»¿",e],{type:e.type}):e},l=function(c,l,p){p||(c=d(c));var v,w,y,m=this,S=c.type,h=!1,R=function(){u(m,"writestart progress write writeend".split(" "))},O=function(){if(w&&r&&"undefined"!=typeof FileReader){var n=new FileReader;return n.onloadend=function(){var e=n.result;w.location.href="data:attachment/file"+e.slice(e.search(/[,;]/)),m.readyState=m.DONE,R()},n.readAsDataURL(c),void(m.readyState=m.INIT)}(!h&&v||(v=t().createObjectURL(c)),w)?w.location.href=v:void 0===e.open(v,"_blank")&&r&&(e.location.href=v);m.readyState=m.DONE,R(),f(v)},g=function(e){return function(){if(m.readyState!==m.DONE)return e.apply(this,arguments)}},b={create:!0,exclusive:!1};if(m.readyState=m.INIT,l||(l="download"),o)return v=t().createObjectURL(c),void setTimeout(function(){var e,t;n.href=v,n.download=l,e=n,t=new MouseEvent("click"),e.dispatchEvent(t),R(),f(v),m.readyState=m.DONE});e.chrome&&S&&"application/octet-stream"!==S&&(y=c.slice||c.webkitSlice,c=y.call(c,0,c.size,"application/octet-stream"),h=!0),i&&"download"!==l&&(l+=".download"),("application/octet-stream"===S||i)&&(w=e),a?(s+=c.size,a(e.TEMPORARY,s,g(function(e){e.root.getDirectory("saved",b,g(function(e){var t=function(){e.getFile(l,b,g(function(e){e.createWriter(g(function(t){t.onwriteend=function(t){w.location.href=e.toURL(),m.readyState=m.DONE,u(m,"writeend",t),f(e)},t.onerror=function(){var e=t.error;e.code!==e.ABORT_ERR&&O()},"writestart progress write abort".split(" ").forEach(function(e){t["on"+e]=m["on"+e]}),t.write(c),m.abort=function(){t.abort(),m.readyState=m.DONE},m.readyState=m.WRITING}),O)}),O)};e.getFile(l,{create:!1},g(function(e){e.remove(),t()}),g(function(e){e.code===e.NOT_FOUND_ERR?t():O()}))}),O)}),O)):O()},p=l.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return n||(e=d(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(p.abort=function(){this.readyState=this.DONE,u(this,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,function(e,t,n){return new l(e,t,n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs});

},{}],2:[function(require,module,exports){
!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define("underscore",r):(n="undefined"!=typeof globalThis?globalThis:n||self,function(){var t=n._,e=n._=r();e.noConflict=function(){return n._=t,e}}())}(this,function(){var n="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},r=Array.prototype,t=Object.prototype,e="undefined"!=typeof Symbol?Symbol.prototype:null,u=r.push,o=r.slice,i=t.toString,a=t.hasOwnProperty,f="undefined"!=typeof ArrayBuffer,c="undefined"!=typeof DataView,l=Array.isArray,s=Object.keys,p=Object.create,v=f&&ArrayBuffer.isView,h=isNaN,y=isFinite,d=!{toString:null}.propertyIsEnumerable("toString"),g=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],b=Math.pow(2,53)-1;function m(n,r){return r=null==r?n.length-1:+r,function(){for(var t=Math.max(arguments.length-r,0),e=Array(t),u=0;u<t;u++)e[u]=arguments[u+r];switch(r){case 0:return n.call(this,e);case 1:return n.call(this,arguments[0],e);case 2:return n.call(this,arguments[0],arguments[1],e)}var o=Array(r+1);for(u=0;u<r;u++)o[u]=arguments[u];return o[r]=e,n.apply(this,o)}}function j(n){var r=typeof n;return"function"===r||"object"===r&&!!n}function _(n){return void 0===n}function w(n){return!0===n||!1===n||"[object Boolean]"===i.call(n)}function A(n){var r="[object "+n+"]";return function(n){return i.call(n)===r}}var x=A("String"),S=A("Number"),O=A("Date"),M=A("RegExp"),E=A("Error"),B=A("Symbol"),N=A("ArrayBuffer"),I=A("Function"),T=n.document&&n.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof T&&(I=function(n){return"function"==typeof n||!1});var k=I,D=A("Object"),R=c&&D(new DataView(new ArrayBuffer(8))),F="undefined"!=typeof Map&&D(new Map),V=A("DataView");var P=R?function(n){return null!=n&&k(n.getInt8)&&N(n.buffer)}:V,q=l||A("Array");function U(n,r){return null!=n&&a.call(n,r)}var W=A("Arguments");!function(){W(arguments)||(W=function(n){return U(n,"callee")})}();var z=W;function L(n){return S(n)&&h(n)}function $(n){return function(){return n}}function C(n){return function(r){var t=n(r);return"number"==typeof t&&t>=0&&t<=b}}function K(n){return function(r){return null==r?void 0:r[n]}}var J=K("byteLength"),G=C(J),H=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var Q=f?function(n){return v?v(n)&&!P(n):G(n)&&H.test(i.call(n))}:$(!1),X=K("length");function Y(n,r){r=function(n){for(var r={},t=n.length,e=0;e<t;++e)r[n[e]]=!0;return{contains:function(n){return!0===r[n]},push:function(t){return r[t]=!0,n.push(t)}}}(r);var e=g.length,u=n.constructor,o=k(u)&&u.prototype||t,i="constructor";for(U(n,i)&&!r.contains(i)&&r.push(i);e--;)(i=g[e])in n&&n[i]!==o[i]&&!r.contains(i)&&r.push(i)}function Z(n){if(!j(n))return[];if(s)return s(n);var r=[];for(var t in n)U(n,t)&&r.push(t);return d&&Y(n,r),r}function nn(n,r){var t=Z(r),e=t.length;if(null==n)return!e;for(var u=Object(n),o=0;o<e;o++){var i=t[o];if(r[i]!==u[i]||!(i in u))return!1}return!0}function rn(n){return n instanceof rn?n:this instanceof rn?void(this._wrapped=n):new rn(n)}function tn(n){return new Uint8Array(n.buffer||n,n.byteOffset||0,J(n))}rn.VERSION="1.13.6",rn.prototype.value=function(){return this._wrapped},rn.prototype.valueOf=rn.prototype.toJSON=rn.prototype.value,rn.prototype.toString=function(){return String(this._wrapped)};var en="[object DataView]";function un(n,r,t,u){if(n===r)return 0!==n||1/n==1/r;if(null==n||null==r)return!1;if(n!=n)return r!=r;var o=typeof n;return("function"===o||"object"===o||"object"==typeof r)&&function n(r,t,u,o){r instanceof rn&&(r=r._wrapped);t instanceof rn&&(t=t._wrapped);var a=i.call(r);if(a!==i.call(t))return!1;if(R&&"[object Object]"==a&&P(r)){if(!P(t))return!1;a=en}switch(a){case"[object RegExp]":case"[object String]":return""+r==""+t;case"[object Number]":return+r!=+r?+t!=+t:0==+r?1/+r==1/t:+r==+t;case"[object Date]":case"[object Boolean]":return+r==+t;case"[object Symbol]":return e.valueOf.call(r)===e.valueOf.call(t);case"[object ArrayBuffer]":case en:return n(tn(r),tn(t),u,o)}var f="[object Array]"===a;if(!f&&Q(r)){var c=J(r);if(c!==J(t))return!1;if(r.buffer===t.buffer&&r.byteOffset===t.byteOffset)return!0;f=!0}if(!f){if("object"!=typeof r||"object"!=typeof t)return!1;var l=r.constructor,s=t.constructor;if(l!==s&&!(k(l)&&l instanceof l&&k(s)&&s instanceof s)&&"constructor"in r&&"constructor"in t)return!1}u=u||[];o=o||[];var p=u.length;for(;p--;)if(u[p]===r)return o[p]===t;u.push(r);o.push(t);if(f){if((p=r.length)!==t.length)return!1;for(;p--;)if(!un(r[p],t[p],u,o))return!1}else{var v,h=Z(r);if(p=h.length,Z(t).length!==p)return!1;for(;p--;)if(v=h[p],!U(t,v)||!un(r[v],t[v],u,o))return!1}u.pop();o.pop();return!0}(n,r,t,u)}function on(n){if(!j(n))return[];var r=[];for(var t in n)r.push(t);return d&&Y(n,r),r}function an(n){var r=X(n);return function(t){if(null==t)return!1;var e=on(t);if(X(e))return!1;for(var u=0;u<r;u++)if(!k(t[n[u]]))return!1;return n!==pn||!k(t[fn])}}var fn="forEach",cn=["clear","delete"],ln=["get","has","set"],sn=cn.concat(fn,ln),pn=cn.concat(ln),vn=["add"].concat(cn,fn,"has"),hn=F?an(sn):A("Map"),yn=F?an(pn):A("WeakMap"),dn=F?an(vn):A("Set"),gn=A("WeakSet");function bn(n){for(var r=Z(n),t=r.length,e=Array(t),u=0;u<t;u++)e[u]=n[r[u]];return e}function mn(n){for(var r={},t=Z(n),e=0,u=t.length;e<u;e++)r[n[t[e]]]=t[e];return r}function jn(n){var r=[];for(var t in n)k(n[t])&&r.push(t);return r.sort()}function _n(n,r){return function(t){var e=arguments.length;if(r&&(t=Object(t)),e<2||null==t)return t;for(var u=1;u<e;u++)for(var o=arguments[u],i=n(o),a=i.length,f=0;f<a;f++){var c=i[f];r&&void 0!==t[c]||(t[c]=o[c])}return t}}var wn=_n(on),An=_n(Z),xn=_n(on,!0);function Sn(n){if(!j(n))return{};if(p)return p(n);var r=function(){};r.prototype=n;var t=new r;return r.prototype=null,t}function On(n){return q(n)?n:[n]}function Mn(n){return rn.toPath(n)}function En(n,r){for(var t=r.length,e=0;e<t;e++){if(null==n)return;n=n[r[e]]}return t?n:void 0}function Bn(n,r,t){var e=En(n,Mn(r));return _(e)?t:e}function Nn(n){return n}function In(n){return n=An({},n),function(r){return nn(r,n)}}function Tn(n){return n=Mn(n),function(r){return En(r,n)}}function kn(n,r,t){if(void 0===r)return n;switch(null==t?3:t){case 1:return function(t){return n.call(r,t)};case 3:return function(t,e,u){return n.call(r,t,e,u)};case 4:return function(t,e,u,o){return n.call(r,t,e,u,o)}}return function(){return n.apply(r,arguments)}}function Dn(n,r,t){return null==n?Nn:k(n)?kn(n,r,t):j(n)&&!q(n)?In(n):Tn(n)}function Rn(n,r){return Dn(n,r,1/0)}function Fn(n,r,t){return rn.iteratee!==Rn?rn.iteratee(n,r):Dn(n,r,t)}function Vn(){}function Pn(n,r){return null==r&&(r=n,n=0),n+Math.floor(Math.random()*(r-n+1))}rn.toPath=On,rn.iteratee=Rn;var qn=Date.now||function(){return(new Date).getTime()};function Un(n){var r=function(r){return n[r]},t="(?:"+Z(n).join("|")+")",e=RegExp(t),u=RegExp(t,"g");return function(n){return n=null==n?"":""+n,e.test(n)?n.replace(u,r):n}}var Wn={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},zn=Un(Wn),Ln=Un(mn(Wn)),$n=rn.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},Cn=/(.)^/,Kn={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},Jn=/\\|'|\r|\n|\u2028|\u2029/g;function Gn(n){return"\\"+Kn[n]}var Hn=/^\s*(\w|\$)+\s*$/;var Qn=0;function Xn(n,r,t,e,u){if(!(e instanceof r))return n.apply(t,u);var o=Sn(n.prototype),i=n.apply(o,u);return j(i)?i:o}var Yn=m(function(n,r){var t=Yn.placeholder,e=function(){for(var u=0,o=r.length,i=Array(o),a=0;a<o;a++)i[a]=r[a]===t?arguments[u++]:r[a];for(;u<arguments.length;)i.push(arguments[u++]);return Xn(n,e,this,this,i)};return e});Yn.placeholder=rn;var Zn=m(function(n,r,t){if(!k(n))throw new TypeError("Bind must be called on a function");var e=m(function(u){return Xn(n,e,r,this,t.concat(u))});return e}),nr=C(X);function rr(n,r,t,e){if(e=e||[],r||0===r){if(r<=0)return e.concat(n)}else r=1/0;for(var u=e.length,o=0,i=X(n);o<i;o++){var a=n[o];if(nr(a)&&(q(a)||z(a)))if(r>1)rr(a,r-1,t,e),u=e.length;else for(var f=0,c=a.length;f<c;)e[u++]=a[f++];else t||(e[u++]=a)}return e}var tr=m(function(n,r){var t=(r=rr(r,!1,!1)).length;if(t<1)throw new Error("bindAll must be passed function names");for(;t--;){var e=r[t];n[e]=Zn(n[e],n)}return n});var er=m(function(n,r,t){return setTimeout(function(){return n.apply(null,t)},r)}),ur=Yn(er,rn,1);function or(n){return function(){return!n.apply(this,arguments)}}function ir(n,r){var t;return function(){return--n>0&&(t=r.apply(this,arguments)),n<=1&&(r=null),t}}var ar=Yn(ir,2);function fr(n,r,t){r=Fn(r,t);for(var e,u=Z(n),o=0,i=u.length;o<i;o++)if(r(n[e=u[o]],e,n))return e}function cr(n){return function(r,t,e){t=Fn(t,e);for(var u=X(r),o=n>0?0:u-1;o>=0&&o<u;o+=n)if(t(r[o],o,r))return o;return-1}}var lr=cr(1),sr=cr(-1);function pr(n,r,t,e){for(var u=(t=Fn(t,e,1))(r),o=0,i=X(n);o<i;){var a=Math.floor((o+i)/2);t(n[a])<u?o=a+1:i=a}return o}function vr(n,r,t){return function(e,u,i){var a=0,f=X(e);if("number"==typeof i)n>0?a=i>=0?i:Math.max(i+f,a):f=i>=0?Math.min(i+1,f):i+f+1;else if(t&&i&&f)return e[i=t(e,u)]===u?i:-1;if(u!=u)return(i=r(o.call(e,a,f),L))>=0?i+a:-1;for(i=n>0?a:f-1;i>=0&&i<f;i+=n)if(e[i]===u)return i;return-1}}var hr=vr(1,lr,pr),yr=vr(-1,sr);function dr(n,r,t){var e=(nr(n)?lr:fr)(n,r,t);if(void 0!==e&&-1!==e)return n[e]}function gr(n,r,t){var e,u;if(r=kn(r,t),nr(n))for(e=0,u=n.length;e<u;e++)r(n[e],e,n);else{var o=Z(n);for(e=0,u=o.length;e<u;e++)r(n[o[e]],o[e],n)}return n}function br(n,r,t){r=Fn(r,t);for(var e=!nr(n)&&Z(n),u=(e||n).length,o=Array(u),i=0;i<u;i++){var a=e?e[i]:i;o[i]=r(n[a],a,n)}return o}function mr(n){return function(r,t,e,u){var o=arguments.length>=3;return function(r,t,e,u){var o=!nr(r)&&Z(r),i=(o||r).length,a=n>0?0:i-1;for(u||(e=r[o?o[a]:a],a+=n);a>=0&&a<i;a+=n){var f=o?o[a]:a;e=t(e,r[f],f,r)}return e}(r,kn(t,u,4),e,o)}}var jr=mr(1),_r=mr(-1);function wr(n,r,t){var e=[];return r=Fn(r,t),gr(n,function(n,t,u){r(n,t,u)&&e.push(n)}),e}function Ar(n,r,t){r=Fn(r,t);for(var e=!nr(n)&&Z(n),u=(e||n).length,o=0;o<u;o++){var i=e?e[o]:o;if(!r(n[i],i,n))return!1}return!0}function xr(n,r,t){r=Fn(r,t);for(var e=!nr(n)&&Z(n),u=(e||n).length,o=0;o<u;o++){var i=e?e[o]:o;if(r(n[i],i,n))return!0}return!1}function Sr(n,r,t,e){return nr(n)||(n=bn(n)),("number"!=typeof t||e)&&(t=0),hr(n,r,t)>=0}var Or=m(function(n,r,t){var e,u;return k(r)?u=r:(r=Mn(r),e=r.slice(0,-1),r=r[r.length-1]),br(n,function(n){var o=u;if(!o){if(e&&e.length&&(n=En(n,e)),null==n)return;o=n[r]}return null==o?o:o.apply(n,t)})});function Mr(n,r){return br(n,Tn(r))}function Er(n,r,t){var e,u,o=-1/0,i=-1/0;if(null==r||"number"==typeof r&&"object"!=typeof n[0]&&null!=n)for(var a=0,f=(n=nr(n)?n:bn(n)).length;a<f;a++)null!=(e=n[a])&&e>o&&(o=e);else r=Fn(r,t),gr(n,function(n,t,e){((u=r(n,t,e))>i||u===-1/0&&o===-1/0)&&(o=n,i=u)});return o}var Br=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function Nr(n){return n?q(n)?o.call(n):x(n)?n.match(Br):nr(n)?br(n,Nn):bn(n):[]}function Ir(n,r,t){if(null==r||t)return nr(n)||(n=bn(n)),n[Pn(n.length-1)];var e=Nr(n),u=X(e);r=Math.max(Math.min(r,u),0);for(var o=u-1,i=0;i<r;i++){var a=Pn(i,o),f=e[i];e[i]=e[a],e[a]=f}return e.slice(0,r)}function Tr(n,r){return function(t,e,u){var o=r?[[],[]]:{};return e=Fn(e,u),gr(t,function(r,u){var i=e(r,u,t);n(o,r,i)}),o}}var kr=Tr(function(n,r,t){U(n,t)?n[t].push(r):n[t]=[r]}),Dr=Tr(function(n,r,t){n[t]=r}),Rr=Tr(function(n,r,t){U(n,t)?n[t]++:n[t]=1}),Fr=Tr(function(n,r,t){n[t?0:1].push(r)},!0);function Vr(n,r,t){return r in t}var Pr=m(function(n,r){var t={},e=r[0];if(null==n)return t;k(e)?(r.length>1&&(e=kn(e,r[1])),r=on(n)):(e=Vr,r=rr(r,!1,!1),n=Object(n));for(var u=0,o=r.length;u<o;u++){var i=r[u],a=n[i];e(a,i,n)&&(t[i]=a)}return t}),qr=m(function(n,r){var t,e=r[0];return k(e)?(e=or(e),r.length>1&&(t=r[1])):(r=br(rr(r,!1,!1),String),e=function(n,t){return!Sr(r,t)}),Pr(n,e,t)});function Ur(n,r,t){return o.call(n,0,Math.max(0,n.length-(null==r||t?1:r)))}function Wr(n,r,t){return null==n||n.length<1?null==r||t?void 0:[]:null==r||t?n[0]:Ur(n,n.length-r)}function zr(n,r,t){return o.call(n,null==r||t?1:r)}var Lr=m(function(n,r){return r=rr(r,!0,!0),wr(n,function(n){return!Sr(r,n)})}),$r=m(function(n,r){return Lr(n,r)});function Cr(n,r,t,e){w(r)||(e=t,t=r,r=!1),null!=t&&(t=Fn(t,e));for(var u=[],o=[],i=0,a=X(n);i<a;i++){var f=n[i],c=t?t(f,i,n):f;r&&!t?(i&&o===c||u.push(f),o=c):t?Sr(o,c)||(o.push(c),u.push(f)):Sr(u,f)||u.push(f)}return u}var Kr=m(function(n){return Cr(rr(n,!0,!0))});function Jr(n){for(var r=n&&Er(n,X).length||0,t=Array(r),e=0;e<r;e++)t[e]=Mr(n,e);return t}var Gr=m(Jr);function Hr(n,r){return n._chain?rn(r).chain():r}function Qr(n){return gr(jn(n),function(r){var t=rn[r]=n[r];rn.prototype[r]=function(){var n=[this._wrapped];return u.apply(n,arguments),Hr(this,t.apply(rn,n))}}),rn}gr(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=r[n];rn.prototype[n]=function(){var r=this._wrapped;return null!=r&&(t.apply(r,arguments),"shift"!==n&&"splice"!==n||0!==r.length||delete r[0]),Hr(this,r)}}),gr(["concat","join","slice"],function(n){var t=r[n];rn.prototype[n]=function(){var n=this._wrapped;return null!=n&&(n=t.apply(n,arguments)),Hr(this,n)}});var Xr=Qr({__proto__:null,VERSION:"1.13.6",restArguments:m,isObject:j,isNull:function(n){return null===n},isUndefined:_,isBoolean:w,isElement:function(n){return!(!n||1!==n.nodeType)},isString:x,isNumber:S,isDate:O,isRegExp:M,isError:E,isSymbol:B,isArrayBuffer:N,isDataView:P,isArray:q,isFunction:k,isArguments:z,isFinite:function(n){return!B(n)&&y(n)&&!isNaN(parseFloat(n))},isNaN:L,isTypedArray:Q,isEmpty:function(n){if(null==n)return!0;var r=X(n);return"number"==typeof r&&(q(n)||x(n)||z(n))?0===r:0===X(Z(n))},isMatch:nn,isEqual:function(n,r){return un(n,r)},isMap:hn,isWeakMap:yn,isSet:dn,isWeakSet:gn,keys:Z,allKeys:on,values:bn,pairs:function(n){for(var r=Z(n),t=r.length,e=Array(t),u=0;u<t;u++)e[u]=[r[u],n[r[u]]];return e},invert:mn,functions:jn,methods:jn,extend:wn,extendOwn:An,assign:An,defaults:xn,create:function(n,r){var t=Sn(n);return r&&An(t,r),t},clone:function(n){return j(n)?q(n)?n.slice():wn({},n):n},tap:function(n,r){return r(n),n},get:Bn,has:function(n,r){for(var t=(r=Mn(r)).length,e=0;e<t;e++){var u=r[e];if(!U(n,u))return!1;n=n[u]}return!!t},mapObject:function(n,r,t){r=Fn(r,t);for(var e=Z(n),u=e.length,o={},i=0;i<u;i++){var a=e[i];o[a]=r(n[a],a,n)}return o},identity:Nn,constant:$,noop:Vn,toPath:On,property:Tn,propertyOf:function(n){return null==n?Vn:function(r){return Bn(n,r)}},matcher:In,matches:In,times:function(n,r,t){var e=Array(Math.max(0,n));r=kn(r,t,1);for(var u=0;u<n;u++)e[u]=r(u);return e},random:Pn,now:qn,escape:zn,unescape:Ln,templateSettings:$n,template:function(n,r,t){!r&&t&&(r=t),r=xn({},r,rn.templateSettings);var e=RegExp([(r.escape||Cn).source,(r.interpolate||Cn).source,(r.evaluate||Cn).source].join("|")+"|$","g"),u=0,o="__p+='";n.replace(e,function(r,t,e,i,a){return o+=n.slice(u,a).replace(Jn,Gn),u=a+r.length,t?o+="'+\n((__t=("+t+"))==null?'':_.escape(__t))+\n'":e?o+="'+\n((__t=("+e+"))==null?'':__t)+\n'":i&&(o+="';\n"+i+"\n__p+='"),r}),o+="';\n";var i,a=r.variable;if(a){if(!Hn.test(a))throw new Error("variable is not a bare identifier: "+a)}else o="with(obj||{}){\n"+o+"}\n",a="obj";o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{i=new Function(a,"_",o)}catch(n){throw n.source=o,n}var f=function(n){return i.call(this,n,rn)};return f.source="function("+a+"){\n"+o+"}",f},result:function(n,r,t){var e=(r=Mn(r)).length;if(!e)return k(t)?t.call(n):t;for(var u=0;u<e;u++){var o=null==n?void 0:n[r[u]];void 0===o&&(o=t,u=e),n=k(o)?o.call(n):o}return n},uniqueId:function(n){var r=++Qn+"";return n?n+r:r},chain:function(n){var r=rn(n);return r._chain=!0,r},iteratee:Rn,partial:Yn,bind:Zn,bindAll:tr,memoize:function(n,r){var t=function(e){var u=t.cache,o=""+(r?r.apply(this,arguments):e);return U(u,o)||(u[o]=n.apply(this,arguments)),u[o]};return t.cache={},t},delay:er,defer:ur,throttle:function(n,r,t){var e,u,o,i,a=0;t||(t={});var f=function(){a=!1===t.leading?0:qn(),e=null,i=n.apply(u,o),e||(u=o=null)},c=function(){var c=qn();a||!1!==t.leading||(a=c);var l=r-(c-a);return u=this,o=arguments,l<=0||l>r?(e&&(clearTimeout(e),e=null),a=c,i=n.apply(u,o),e||(u=o=null)):e||!1===t.trailing||(e=setTimeout(f,l)),i};return c.cancel=function(){clearTimeout(e),a=0,e=u=o=null},c},debounce:function(n,r,t){var e,u,o,i,a,f=function(){var c=qn()-u;r>c?e=setTimeout(f,r-c):(e=null,t||(i=n.apply(a,o)),e||(o=a=null))},c=m(function(c){return a=this,o=c,u=qn(),e||(e=setTimeout(f,r),t&&(i=n.apply(a,o))),i});return c.cancel=function(){clearTimeout(e),e=o=a=null},c},wrap:function(n,r){return Yn(r,n)},negate:or,compose:function(){var n=arguments,r=n.length-1;return function(){for(var t=r,e=n[r].apply(this,arguments);t--;)e=n[t].call(this,e);return e}},after:function(n,r){return function(){if(--n<1)return r.apply(this,arguments)}},before:ir,once:ar,findKey:fr,findIndex:lr,findLastIndex:sr,sortedIndex:pr,indexOf:hr,lastIndexOf:yr,find:dr,detect:dr,findWhere:function(n,r){return dr(n,In(r))},each:gr,forEach:gr,map:br,collect:br,reduce:jr,foldl:jr,inject:jr,reduceRight:_r,foldr:_r,filter:wr,select:wr,reject:function(n,r,t){return wr(n,or(Fn(r)),t)},every:Ar,all:Ar,some:xr,any:xr,contains:Sr,includes:Sr,include:Sr,invoke:Or,pluck:Mr,where:function(n,r){return wr(n,In(r))},max:Er,min:function(n,r,t){var e,u,o=1/0,i=1/0;if(null==r||"number"==typeof r&&"object"!=typeof n[0]&&null!=n)for(var a=0,f=(n=nr(n)?n:bn(n)).length;a<f;a++)null!=(e=n[a])&&e<o&&(o=e);else r=Fn(r,t),gr(n,function(n,t,e){((u=r(n,t,e))<i||u===1/0&&o===1/0)&&(o=n,i=u)});return o},shuffle:function(n){return Ir(n,1/0)},sample:Ir,sortBy:function(n,r,t){var e=0;return r=Fn(r,t),Mr(br(n,function(n,t,u){return{value:n,index:e++,criteria:r(n,t,u)}}).sort(function(n,r){var t=n.criteria,e=r.criteria;if(t!==e){if(t>e||void 0===t)return 1;if(t<e||void 0===e)return-1}return n.index-r.index}),"value")},groupBy:kr,indexBy:Dr,countBy:Rr,partition:Fr,toArray:Nr,size:function(n){return null==n?0:nr(n)?n.length:Z(n).length},pick:Pr,omit:qr,first:Wr,head:Wr,take:Wr,initial:Ur,last:function(n,r,t){return null==n||n.length<1?null==r||t?void 0:[]:null==r||t?n[n.length-1]:zr(n,Math.max(0,n.length-r))},rest:zr,tail:zr,drop:zr,compact:function(n){return wr(n,Boolean)},flatten:function(n,r){return rr(n,r,!1)},without:$r,uniq:Cr,unique:Cr,union:Kr,intersection:function(n){for(var r=[],t=arguments.length,e=0,u=X(n);e<u;e++){var o=n[e];if(!Sr(r,o)){var i;for(i=1;i<t&&Sr(arguments[i],o);i++);i===t&&r.push(o)}}return r},difference:Lr,unzip:Jr,transpose:Jr,zip:Gr,object:function(n,r){for(var t={},e=0,u=X(n);e<u;e++)r?t[n[e]]=r[e]:t[n[e][0]]=n[e][1];return t},range:function(n,r,t){null==r&&(r=n||0,n=0),t||(t=r<n?-1:1);for(var e=Math.max(Math.ceil((r-n)/t),0),u=Array(e),o=0;o<e;o++,n+=t)u[o]=n;return u},chunk:function(n,r){if(null==r||r<1)return[];for(var t=[],e=0,u=n.length;e<u;)t.push(o.call(n,e,e+=r));return t},mixin:Qr,default:rn});return Xr._=Xr,Xr});

},{}],3:[function(require,module,exports){
var filesaver=require("filesaver.js-npm"),_=require("underscore"),dotGraph={};!function(e){var t="https://corsproxy.io/?",n=location.protocol+"//mcdemarco.net/games/bgg/proxy.php?csurl=",a={checkpoint:!0,checkpointTag:"checkpoint",cluster:!1,clusterTags:[],color:"length",countWords:!0,display:!0,dotExtension:"gv",ends:!0,endTag:"end",engine:"dot",hideSource:!1,hideSettings:!1,increment:.2,lastTag:!1,omitSpecialPassages:!0,omitSpecialTags:!0,omitTags:[],prefix:"",postfix:"",renumber:!1,rotation:"TB",scale:"100%",showNodeNames:!1,showSettings:!1,showTagKey:"default",snowstick:!1,source:"dot",tooltips:!0,trace:"",palette:["#FEAF16","#2ED9FF","#DEA0FD","#FE00FA","#F7E1A0","#16FF32","#3283FE","#1C8356","#FBE426","#FA0087","#F8A19F","#1CBE4F","#C4451C","#C075A6","#90AD1C","#B00068","#AA0DFE","#FC1CBF","#1CFFCE","#F6222E","#85660D","#325A9B","#B10DA1","#A0A0A0","#782AB6","#565656"],paletteExceptions:{start:"#C8C8C8",ends:"#C8C8C8",unreachable:"#FF6666",untagged:"#FFFFFF",trace:"#FF8000",default:"#FFFFFF",leafHue:.3,readHue:.22}},o={},s=["StoryTitle","StoryIncludes","StoryData","StoryAuthor","StorySubtitle","StoryMenu","StorySettings","StoryColophon","StoryBanner","StoryCaption","StoryInit","StoryShare","PassageDone","PassageFooter","PassageHeader","PassageReady","MenuOptions","MenuShare","DotGraphSettings"],r=["annotation","debug-footer","debug-header","debug-startup","footer","haml","header","script","startup","stylesheet","twee2","transition","Twine.private","widget"],i={title:"Untitled",startNode:1,startNodeName:"Start",leaves:0,links:0,tightEnds:0,avLength:1,maxLength:1,passages:[],reachable:[],tags:[],tagObject:[],targets:{},twineVersion:0},l=new Viz;e.dot=function(){return{convert:function(){var t=[];t.push("digraph "+c(i.title)+" {"),t.push("rankdir="+a.rotation+"\r\n"),a.cluster&&(t=t.concat(function(t){var n=[],s=0;for(var r in t)t.hasOwnProperty(r)&&!e.settings.isOmittedTag(r)&&(0==a.clusterTags.length||a.clusterTags.indexOf(r)>-1)&&(n.push("subgraph cluster_"+s+" {"),n.push("label="+c(r)),n.push('style="rounded, filled" fillcolor="ivory"'),n.push(t[r].map(o).join(" \r\n")),n.push("}\r\n"),s++);return n}(i.tagObject)));("tag"==a.color&&i.tags.length!=a.clusterTags.length&&"default"==a.showTagKey||"always"==a.showTagKey)&&(t=t.concat(function(t,n){var a,o,s=[];s.push("subgraph cluster_tagKey {"),s.push('label="Tags"'),s.push('style="rounded, filled" fillcolor="white"'),s.push("rank=same");for(var r=0;r<t.tags.length;r++)e.settings.isOmittedTag(i.tags[r])||(a=c(i.tags[r]),o="tagKeyNodeID_"+r,s.push(o+" [label="+a+' shape=rect style="filled,rounded" fillcolor="'+n.palette[r%26]+'" fontcolor="'+n.paletteContrastColors[r%26]+'"]'));s.push("}");var l=n.showNodeNames?c(t.startNodeName):t.startNode;for(r=0;r<t.tags.length;r++)e.settings.isOmittedTag(t.tags[r])||(o="tagKeyNodeID_"+r),s.push(o+" -> "+l+" [style=invis]");return s}(i,a)));return(t=t.concat(function(){var e=[];if(a.renumber&&!a.showNodeNames){var t;for(t=0;t<i.passages.length;++t)i.passages[t].pid==i.startNode&&(e=e.concat(r(i.passages[t],1)));var n=2;for(t=0;t<i.passages.length;++t){var o=i.passages[t];o.pid==i.startNode||a.omitSpecialPassages&&o.special||o.omit||(e=e.concat(r(o,n)),n++)}}else for(t=0;t<i.passages.length;++t)i.passages[t].omit||(e=e.concat(r(i.passages[t])));return e}())).push('\r\nlabelloc="t"\r\n'),t.push("label="+c(i.title)),t.push("\r\n}"),t.join("\r\n")},render:function(){var t=document.getElementById("dotfile").value;document.getElementById("graph").innerHTML="",l.renderSVGElement(t,{engine:a.engine}).then(function(t){t.setAttribute("id","graphviz"),document.getElementById("graph").appendChild(t),e.graph.scale(),a.snowstick&&document.querySelectorAll("#graph g.node text").forEach(function(t){t.addEventListener("click",e.settings.bookmark,!1)})}).catch(function(e){l=new Viz,console.log(e)})}};function t(e){return i.targets.hasOwnProperty(e)?i.targets[e]:c(e)}function n(e,t,n,o){var s;return s=(t?!a.showNodeNames:a.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",n&&a.countWords&&(s+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(s=a.prefix+s+a.postfix),c(s)}function o(e){return a.showNodeNames?c(e):t(e)}function s(e,t,n){return e.toFixed(2)+","+t.toFixed(2)+","+n.toFixed(2)}function r(o,r){var l=[];if(a.omitSpecialPassages&&o.special||o.omit)return l;var d=n(o),g=function(t,o){var r=[],l=0,c=0,d=1,g=t.pid,u=(t.content,t.theTag);a.snowstick&&t.ssBookmark?r.push("shape=note"):t.trace?r.push("shape=hexagon"):g==i.startNode||_.find(i.unreachable,function(e){return e==t.name})?r.push("shape=doublecircle"):a.ends&&e.passage.hasTag(t,a.endTag)?r.push("shape=egg"):a.checkpoints&&e.passage.hasTag(t,a.checkpointTag)&&r.push("shape=diamond");0===r.length&&0===t.links.length&&a.ends?r.push('style="filled,diagonals"'):r.length?r.push('style="filled,bold"'):"bw"!=a.color&&r.push("style=filled");if("length"==a.color)l=Math.round(100*Math.min(1.75,t.textLength/i.avLength)/3)/100,r.push('fillcolor="'+l+',0.66,0.85"');else if("tag"==a.color&&u){var p=i.tags.indexOf(u);p>-1&&(l=a.palette[p%26]),r.push('fillcolor="'+l+'"'),r.push('fontcolor="'+a.paletteContrastColors[p%26]+'"')}else"tag"==a.color||(a.snowstick&&t.ssLeaf&&(a.ends&&e.passage.hasTag(t,a.endTag)||t.leaf)?(l=a.paletteExceptions.leafHue,r.push('fillcolor="'+s(l,.9,.5)+'"')):a.snowstick&&t.ssLeaf?(l=a.paletteExceptions.leafHue,c=t.ssLeaf,d=Math.round(100*t.ssLeaf/5)/100+.5,r.push('fillcolor="'+s(l,c,d)+'"')):t.trace?r.push('fillcolor="'+a.paletteExceptions.trace+'"'):a.snowstick&&t.ssRead?(l=a.paletteExceptions.readHue,c=t.ssRead,d=Math.round(100*t.ssRead/5)/100+.79,r.push('fillcolor="'+s(l,c,d)+'"')):g==i.startNode?r.push('fillcolor="'+a.paletteExceptions.start+'"'):a.ends&&e.passage.hasTag(t,a.endTag)?r.push('fillcolor="'+a.paletteExceptions.ends+'"'):_.find(i.unreachable,function(e){return e==t.name})?r.push('fillcolor="'+a.paletteExceptions.unreachable+'"'):"tag"==a.color?r.push('fillcolor="'+a.paletteExceptions.untagged+'"'):r.push('fillcolor="'+a.paletteExceptions.default+'"'));(o||a.prefix||a.postfix)&&(o?r.push('label="'+a.prefix+o+a.postfix+'"'):r.push("label="+n(t,!1,!1,!0)));a.tooltips&&r.push("tooltip="+n(t,!0,!0));return r}(o,r),u=function(e,n){for(var o=[],s=0;s<e.links.length;s++){var r=e.links[s][0],i=n+" -> "+(a.showNodeNames?c(r):t(r));e.links[s][1]&&(i+=" [style = dashed]"),o.push(i)}return o}(o,d);return l.push("\r\n"+d+" ["+g.join(" ")+"]"),l=l.concat(u)}function c(e){return e&&(e='"'+(e=e.toString().replace(/"/gm,'\\"'))+'"'),e}}(),e.gml=function(){return{convert:function(){var t=[],n=e.settings.ifid().replace(/[A-F\-]/g,"").substr(0,6);t.push("graph ["),t.push("directed 1"),t.push("id "+(n||i.passages.length+1800)),t.push("label "+s(i.title)),a.cluster;"tag"==a.color&&(i.tags.length,a.clusterTags.length);var r=function(){var e,t={nodes:[],edges:[]};if(a.renumber&&!a.showNodeNames){var n;for(n=0;n<i.passages.length;++n)i.passages[n].pid==i.startNode&&(e=o(i.passages[n],1),t.nodes=t.nodes.concat(e.node),t.edges=t.edges.concat(e.edges));var s=2;for(n=0;n<i.passages.length;++n){var r=i.passages[n];r.pid==i.startNode||a.omitSpecialPassages&&r.special||r.omit||(e=o(r,s),t.nodes=t.nodes.concat(e.node),t.edges=t.edges.concat(e.edges),s++)}}else for(n=0;n<i.passages.length;++n)i.passages[n].omit||(e=o(i.passages[n]),t.nodes=t.nodes.concat(e.node),t.edges=t.edges.concat(e.edges));return t}();return(t=(t=t.concat(r.nodes.join(""))).concat(r.edges.join("\r\n"))).push("\r\n]"),t.join("\r\n\t")}};function t(e){return i.targets.hasOwnProperty(e)?i.targets[e]:s(e)}function n(e,t,n,o){var r;return r=(t?!a.showNodeNames:a.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",n&&a.countWords&&(r+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(r=a.prefix+r+a.postfix),s(r)}function o(e,o){var s={node:[],edges:[]};if(a.omitSpecialPassages&&e.special||e.omit)return s;var r=[];e.pid!=i.startNode&&r.push("\t"),r.push("node ["),r.push("\tid "+e.pid),r.push("\tlabel "+function(e,t){t=t||a.prefix||a.postfix?t?'"'+a.prefix+t+a.postfix+'"':n(e,!1,!1,!0):n(e);return t}(e,o)),r.push("]"),s.node.push(r.join("\r\n\t"));n(e);return s.edges=function(e,n){for(var a=[],o=0;o<e.links.length;o++){var s=e.links[o][0],r=(e.pid!=i.startNode||o>0?"\t":"")+"edge [\r\n\t\tsource "+e.pid+"\r\n\t\ttarget "+t(s);e.links[o][1]&&(r+=" \r\n\t\tlabel display"),r+="\r\n\t]",a.push(r)}return a}(e),s}function s(e){return e&&(e='"'+(e=e.toString().replace(/"/gm,'\\"'))+'"'),e}}(),e.graphml=function(){return{convert:function(){var t=[],n=e.settings.ifid(),o='<?xml version="1.0" encoding="UTF-8"?>\r\n<graphml xmlns="http://graphml.graphdrawing.org/xmlns" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://graphml.graphdrawing.org/xmlns http://graphml.graphdrawing.org/xmlns/1.0/graphml.xsd" xmlns:y="http://www.yworks.com/xml/yfiles-common/3.0" xmlns:x="http://www.yworks.com/xml/yfiles-common/markup/3.0" xmlns:yjs="http://www.yworks.com/xml/yfiles-for-html/2.0/xaml">\r\n\t<key id="g4" for="node" attr.name="label"/>\r\n\t<key id="d4" for="node" attr.name="NodeLabels" y:attr.uri="http://www.yworks.com/xml/yfiles-common/2.0/NodeLabels"/>\r\n\t<key id="g7" for="node" attr.name="color"/>\r\n\t<key id="d7" for="node" attr.name="NodeStyle" y:attr.uri="http://www.yworks.com/xml/yfiles-common/2.0/NodeStyle"/>\r\n\t<graph id="'+(n||i.passages.length+1800)+'" edgedefault="directed">\r\n\t\t';t.push("<desc>"+i.title+"</desc>"),t=t.concat(function(){var e=[];if(a.renumber&&!a.showNodeNames){var t;for(t=0;t<i.passages.length;++t)i.passages[t].pid==i.startNode&&(e=e.concat(s(i.passages[t],1)));var n=2;for(t=0;t<i.passages.length;++t){var o=i.passages[t];o.pid==i.startNode||a.omitSpecialPassages&&o.special||o.omit||(e=e.concat(s(o,n)),n++)}}else for(t=0;t<i.passages.length;++t)i.passages[t].omit||(e=e.concat(s(i.passages[t])));return e}());return o+t.join("\r\n\t\t")+"\r\n\t</graph>\r\n</graphml>\r\n"}};function t(e){return i.targets.hasOwnProperty(e)?i.targets[e]:r(e)}function n(e,t,n,o){var s;return s=(t?!a.showNodeNames:a.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",n&&a.countWords&&(s+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(s=a.prefix+s+a.postfix),r(s)}function o(e,t,n){var a,o,s,r,i,l,c,d;switch(l=n*(1-t),c=n*(1-(i=6*e-(r=Math.floor(6*e)))*t),d=n*(1-(1-i)*t),r%6){case 0:a=n,o=d,s=l;break;case 1:a=c,o=n,s=l;break;case 2:a=l,o=n,s=d;break;case 3:a=l,o=c,s=n;break;case 4:a=d,o=l,s=n;break;case 5:a=n,o=l,s=c}return a=Math.round(255*a).toString(16),o=Math.round(255*o).toString(16),s=Math.round(255*s).toString(16),"#"+(1==a.length?"0":"")+a+(1==o.length?"0":"")+o+(1==s.length?"0":"")+s}function s(s,r){var l=[];if(a.omitSpecialPassages&&s.special||s.omit)return l;n(s);var c=function(t,s){var r,l,c,d=[],g=0,u=0,p=1,h=t.pid,m=(t.content,t.theTag);r=a.snowstick&&t.ssBookmark?"TRAPEZ":t.trace?"HEXAGON":h==i.startNode||_.find(i.unreachable,function(e){return e==t.name})?"OCTAGON":a.ends&&e.passage.hasTag(t,a.endTag)?"ROUND_RECTANGLE":a.checkpoints&&e.passage.hasTag(t,a.checkpointTag)?"DIAMOND":"ELLIPSE";if(c="BLACK","length"==a.color)g=Math.round(100*Math.min(1.75,t.textLength/i.avLength)/3)/100,l=o(g,.66,.85);else if("tag"==a.color&&m){var f=i.tags.indexOf(m);f>-1&&(g=a.palette[f%26]),l=g,c=a.paletteContrastColors[f%26]}else"tag"==a.color||(a.snowstick&&t.ssLeaf&&(a.ends&&e.passage.hasTag(t,a.endTag)||t.leaf)?(g=a.paletteExceptions.leafHue,l=o(g,.9,.5)):a.snowstick&&t.ssLeaf?(g=a.paletteExceptions.leafHue,u=t.ssLeaf,p=Math.round(100*t.ssLeaf/5)/100+.5,l=o(g,u,p)):t.trace?l=a.paletteExceptions.trace:a.snowstick&&t.ssRead?(g=a.paletteExceptions.readHue,u=t.ssRead,p=Math.round(100*t.ssRead/5)/100+.79,l=o(g,u,p)):l=h==i.startNode?a.paletteExceptions.start:a.ends&&e.passage.hasTag(t,a.endTag)?a.paletteExceptions.ends:_.find(i.unreachable,function(e){return e==t.name})?a.paletteExceptions.unreachable:"tag"==a.color?a.paletteExceptions.untagged:a.paletteExceptions.default);d.push('\t<data key="g7">'+l+"</data>"),d.push('\t<data key="d7">'),d.push('\t\t<yjs:ShapeNodeStyle fill="'+l+'" shape="'+r+'"/>'),d.push("\t</data>"),s=s||a.prefix||a.postfix?s?a.prefix+s+a.postfix:n(t,!1,!1,!0):n(t);return d.push('\t<data key="g4">'+s+"</data>"),d.push('\t<data key="d4">'),d.push("\t\t<x:List>"),d.push('\t\t\t<y:Label LayoutParameter="{x:Static y:InteriorLabelModel.Center}">'),d.push("\t\t\t\t<y:Label.Text>"+s+"</y:Label.Text>"),d.push("\t\t\t\t<y:Label.Style>"),d.push('\t\t\t\t\t<yjs:DefaultLabelStyle horizontalTextAlignment="CENTER" textFill="'+c+'"/>'),d.push("\t\t\t\t</y:Label.Style>"),d.push("\t\t\t</y:Label>"),d.push("\t\t</x:List>"),d.push("\t</data>"),d}(s,r);l.push('<node id="'+s.pid+'">'),(l=l.concat(c)).push("</node>");var d=function(e,n){for(var a=[],o=0;o<e.links.length;o++){var s=e.links[o][0],r='<edge source="'+e.pid+'" target="'+t(s)+'">';e.links[o][1]&&(r+="<desc>display link</desc>"),r+="</edge>",a.push(r)}return a}(s);return l=l.concat(d)}function r(e){return e&&(e=e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")),e}}(),e.json=function(){return{convert:function(){var t=[];a.cluster&&(t=function(t){var n,o=[],s=0;for(var i in t)t.hasOwnProperty(i)&&!e.settings.isOmittedTag(i)&&(0==a.clusterTags.length||a.clusterTags.indexOf(i)>-1)&&(n={id:"c"+s,name:r(i),color:a.palette[s%26],contrastColor:a.paletteContrastColors[s%26]},o.push(n),s++);return o}(i.tagObject));var n=function(e){for(var t,n={nodes:[],links:[]},o={},r=0;r<e.length;r++){var l=e[r];o[l.name]=l.id}if(a.renumber&&!a.showNodeNames){var c;for(c=0;c<i.passages.length;++c)i.passages[c].pid==i.startNode&&(t=s(i.passages[c],1,o),n.nodes=n.nodes.concat(t.node),n.links=n.links.concat(t.links));var d=2;for(c=0;c<i.passages.length;++c){var g=i.passages[c];g.pid==i.startNode||a.omitSpecialPassages&&g.special||g.omit||(t=s(g,d,o),n.nodes=n.nodes.concat(t.node),n.links=n.links.concat(t.links),d++)}}else for(c=0;c<i.passages.length;++c)i.passages[c].omit||(t=s(i.passages[c],null,o),n.nodes=n.nodes.concat(t.node),n.links=n.links.concat(t.links));return n}(t);t.length>0&&(n.clusters=t);n.settings={title:r(i.title)};var o=e.settings.ifid();o&&(n.settings.ifid=o);"dot"==a.engine&&(n.settings.rankdir=a.rotation);return JSON.stringify(n,null,"\t")},render:function(){var t=JSON.parse(document.getElementById("jsonfile").value);document.getElementById("graph").innerHTML="<svg></svg>";var n={};t.settings&&t.settings.rankdir&&(n.rankdir=t.settings.rankdir);var a,o,s=new dagreD3.graphlib.Graph({compound:!0}).setGraph(n).setDefaultEdgeLabel(function(){return{}});for(a=0;a<t.nodes.length;a++){var r={label:(o=t.nodes[a]).label?o.label:o.name};o.color&&(r.style="fill: "+o.color+(o.contrastColor?"; stroke-color:"+o.contrastColor:"")+(o.trace?";stroke-width: 3px":"")),o.shape&&(r.shape=o.shape),s.setNode(o.id,r)}if(t.clusters){for(var i=0;i<t.clusters.length;i++){var l=t.clusters[i];s.setNode(l.id,{label:l.name,clusterLabelPos:"top",style:"fill: "+l.color+(l.contrastColor?"; stroke-color:"+l.contrastColor:"")})}for(a=0;a<t.nodes.length;a++)(o=t.nodes[a]).cluster&&s.setParent(o.id,o.cluster)}for(var c=0;c<t.links.length;c++){var d=t.links[c],g={curve:d3.curveBasis};d.category&&"display"==d.category&&(g.style="stroke-dasharray: 5, 5;"),s.setEdge(d.source,d.target,g)}s.nodes().forEach(function(e){var t=s.node(e);t.rx=t.ry=5});var u=new dagreD3.render,p=d3.select("svg"),h=p.append("g");u(d3.select("svg g"),s),p.attr("id","dagre"),p.attr("width","100%"),isFinite(s.graph().width)&&isFinite(s.graph().height)&&(p.attr("viewBox","0 0 "+(s.graph().width+100)+" "+(s.graph().height+100)),h.attr("transform","scale(1 1) translate(50, 50)"));e.graph.scale()}};function t(e){return i.targets.hasOwnProperty(e)?i.targets[e]:r(e)}function n(e,t,n,o){var s;return s=(t?!a.showNodeNames:a.showNodeNames)?e.name:e.pid?e.pid:"Untitled Passage",n&&a.countWords&&(s+=" ("+e.wordCount+" word"+(1==e.wordCount?"":"s")+")"),o&&(s=a.prefix+s+a.postfix),r(s)}function o(e,t,n){var a,o,s,r,i,l,c,d;switch(l=n*(1-t),c=n*(1-(i=6*e-(r=Math.floor(6*e)))*t),d=n*(1-(1-i)*t),r%6){case 0:a=n,o=d,s=l;break;case 1:a=c,o=n,s=l;break;case 2:a=l,o=n,s=d;break;case 3:a=l,o=c,s=n;break;case 4:a=d,o=l,s=n;break;case 5:a=n,o=l,s=c}return a=Math.round(255*a).toString(16),o=Math.round(255*o).toString(16),s=Math.round(255*s).toString(16),"#"+(1==a.length?"0":"")+a+(1==o.length?"0":"")+o+(1==s.length?"0":"")+s}function s(s,r,l){var c={node:[],links:[]};if(a.omitSpecialPassages&&s.special||s.omit)return c;var d=n(s),g=function(t,s){var r={},l=0,c=0,d=1,g=t.pid,u=(t.content,t.theTag);t.trace&&(r.trace=!0);a.snowstick&&t.ssBookmark?r.shape="rect":g==i.startNode||_.find(i.unreachable,function(e){return e==t.name})?r.shape="circle":a.ends&&e.passage.hasTag(t,a.endTag)?r.shape="rect":a.checkpoints&&e.passage.hasTag(t,a.checkpointTag)?r.shape="diamond":a.showNodeNames?r.shape="ellipse":r.shape="circle";if("BLACK","length"==a.color)l=Math.round(100*Math.min(1.75,t.textLength/i.avLength)/3)/100,r.color=o(l,.66,.85);else if("tag"==a.color&&u){var p=i.tags.indexOf(u);p>-1&&(l=a.palette[p%26]),r.color=l,r.contrastColor=a.paletteContrastColors[p%26]}else"tag"==a.color||(a.snowstick&&t.ssLeaf&&(a.ends&&e.passage.hasTag(t,a.endTag)||t.leaf)?(l=a.paletteExceptions.leafHue,r.color=o(l,.9,.5)):a.snowstick&&t.ssLeaf?(l=a.paletteExceptions.leafHue,c=t.ssLeaf,d=Math.round(100*t.ssLeaf/5)/100+.5,r.color=o(l,c,d)):t.trace?r.color=a.paletteExceptions.trace:a.snowstick&&t.ssRead?(l=a.paletteExceptions.readHue,c=t.ssRead,d=Math.round(100*t.ssRead/5)/100+.79,r.color=o(l,c,d)):g==i.startNode?r.color=a.paletteExceptions.start:a.ends&&e.passage.hasTag(t,a.endTag)?r.color=a.paletteExceptions.ends:_.find(i.unreachable,function(e){return e==t.name})?r.color=a.paletteExceptions.unreachable:"tag"==a.color?r.color=a.paletteExceptions.untagged:r.color=a.paletteExceptions.default);s||a.prefix||a.postfix?r.label=s?a.prefix+s+a.postfix:n(t,!1,!1,!0):r.label=n(t);return r}(s,r),u={id:s.pid,name:d};for(var p in g)g.hasOwnProperty(p)&&(u[p]=g[p]);if(a.cluster){var h=function(e,t){for(var n=0;n<e.length;n++){var a=e[n];if(t.hasOwnProperty(a))return t[a]}return null}(s.tagArray,l);h&&(u.cluster=h)}return c.node.push(u),c.links=function(e,n){for(var a=[],o=0;o<e.links.length;o++){var s=e.links[o][0],r={source:e.pid,target:t(s)};e.links[o][1]&&(r.category="display"),a.push(r)}return a}(s),c}function r(e){return e}}(),e.graph=function(){return{contrastColor:function(e){if("#"!=e.charAt(0)||(e.length-1)%3!=0)return"#000000";var t=[];t=e.length-1==3?[e.charAt(1),e.charAt(2),e.charAt(3)]:[e.substring(1,3),e.substring(3,5),e.substring(5,7)];return.299*(t=t.map(function(e){return parseInt(e,16)/255}))[0]+.587*t[1]+.114*t[2]>.5?"#000000":"#ffffff"},convert:function(n){e.settings.parse(n),e.story.parse();var o=e[a.source].convert();document.getElementById(a.source+"file").value=o,"json"!=a.source&&"dot"!=a.source&&(o=e.dot.convert(),document.getElementById("dotfile").value=o);t(n)},render:t,saveSource:function(){var e=document.getElementById(a.source+"file").value,t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=a.source;"dot"==n&&(n=a.dotExtension);filesaver.saveAs(t,a.source+Date.now()+"."+n,!0)},saveSvg:function(){var e=document.getElementById("graph").firstChild.outerHTML,t=new Blob([e],{type:"image/svg+xml;charset=utf-8"});filesaver.saveAs(t,"dotgraph"+Date.now()+".svg",!0)},scale:function(e){var t=document.getElementsByTagName("svg")[0];if(t.removeAttribute("height"),a.scale){if(void 0!==e){var n=a.scale.split(/(\d+)/),o=n[n.length-1];a.scale=parseInt(parseInt(t.getAttribute("width"),10)*(1+e),10)+o}}else{var s=t.getAttribute("viewBox").split(" ");a.scale=void 0===e?s[2]+"pt":parseFloat(t.getAttribute("width"))+parseFloat(s[2])*e+"pt"}t.setAttribute("width",a.scale),document.getElementById("scaleInput").value=a.scale}};function t(t){"json"==a.source?e.json.render():e.dot.render()}}(),e.init=function(){return{load:function(){e.settings.load(),e.settings.write(),e.settings.source(),e.settings.toggle(),document.getElementById("settingsForm").addEventListener("click",e.graph.convert,!1),document.getElementById("clusterTags").addEventListener("input",_.debounce(e.graph.convert,1e3),!1),document.getElementById("omitTags").addEventListener("input",_.debounce(e.graph.convert,1e3),!1),document.getElementById("trace").addEventListener("input",_.debounce(e.graph.convert,1e3),!1),document.getElementById("editButton").addEventListener("click",e.graph.render,!1),document.getElementById("saveSourceButton").addEventListener("click",e.graph.saveSource,!1),document.getElementById("saveSvgButton").addEventListener("click",e.graph.saveSvg,!1),document.getElementById("sourceSelect").addEventListener("change",e.settings.source,!1),document.getElementById("scaleInput").addEventListener("change",function(){e.settings.scale()},!1),document.getElementById("scaleUpButton").addEventListener("click",function(){e.graph.scale(a.increment)},!1),document.getElementById("scaleDownButton").addEventListener("click",function(){e.graph.scale(-a.increment)},!1),document.getElementById("graphHeader").addEventListener("click",function(){e.settings.toggle("graphSection")},!1),document.getElementById("settingsHeader").addEventListener("click",function(){e.settings.toggle("settingsSection")},!1),document.getElementById("sourceHeader").addEventListener("click",function(){e.settings.toggle("sourceSection")},!1),window.location.search&&window.location.search.split("?")[1].length>0&&e.story.load(window.location.search.substring(1))}}}(),e.passage=function(){return{hasTag:function(e,t){return e.tagArray.indexOf(t)>-1},parse:function(n,r){var i={},l=n.getAttribute("tags")?n.getAttribute("tags").trim().split(" "):[],c=function(e){var n,o,s,r=[],i=/\[\[(.*?)\]\]/g,l=/\<\<display \"(.*?)\"\>\>/g,c=/\(display: \"(.*?)\"\)/g,d=/\<\<include \"(.*?)\"( \".*\")?\>\>/g;if(e){for(e=(e=e.replace(/\/\*.*\*\//g,"")).replace(/^\/\/.*(\r\n?|\n)/g,"");null!==(n=i.exec(e));)o=t(n[1],0),/^\w+:\/\/\/?\w/i.test(o)||r.push(o);if(a.display){for(;null!==(n=l.exec(e));)s=t(n[1],1),/^\w+:\/\/\/?\w/i.test(s)||r.push(s);for(;null!==(n=c.exec(e));)s=t(n[1],1),r.push(s);for(;null!==(n=d.exec(e));)s=t(n[1],1),r.push(s)}}return r}(n.innerText);i.content=n.innerText,i.links=c,i.leaf=0===c.length,i.textLength=n.innerText.length,i.wordCount=n.innerText.trim()?n.innerText.trim().split(/\s+/).length:0,i.pid=n.getAttribute("pid")?n.getAttribute("pid"):r,i.tagArray=l,i.theTag=function(e){var t=e.slice(0);return a.ends&&t.indexOf(a.endTag)>-1&&t.splice(t.indexOf(a.endTag),1),a.checkpoints&&t.indexOf(a.checkpointTag)>-1&&t.splice(t.indexOf(a.checkpointTag),1),t.length&&a.lastTag?t[t.length-1]:t.length?t[0]:""}(l),i.name=n.getAttribute("name")?n.getAttribute("name"):n.getAttribute("tiddler")?n.getAttribute("tiddler"):"Untitled Passage",i.special=s.indexOf(i.name)>-1,i.omit=function(t){if(0==a.omitTags.length&&0==a.omitSpecialTags)return!1;for(var n=0;n<t.tagArray.length;n++)if(e.settings.isOmittedTag(t.tagArray[n]))return!0;return!1}(i),i.trace=a.trace&&n.innerText.indexOf(a.trace)>-1,a.snowstick&&(i.ssLeaf=Math.max(o.leaf.indexOf(i.name),0)/Math.max(o.leaf.length,1),i.ssRead=Math.max(o.read.indexOf(i.name),0)/Math.max(o.read.length,1),i.ssBookmark=o.bookmark==i.name);return i}};function t(e,t){var n=e.indexOf("|");if(-1!=n)e=e.substr(n+1);else{var a=e.indexOf("->");if(-1!=a)e=e.substr(a+2);else{var o=e.indexOf("<-");-1!=o&&(e=e.substr(0,o))}}return[e,t]}}(),e.settings=function(){return{bookmark:function(e){var n=e.target.innerHTML;if(!a.showNodeNames)return;if(n){var s=t()?"-"+t():"";try{localStorage.setItem("snowstick-bookmark"+s,n),o.bookmark=localStorage.getItem("snowstick-bookmark"+s)?localStorage.getItem("snowstick-bookmark"+s):""}catch(e){console.log("Bookmarking failed.")}}},ifid:t,isOmittedTag:function(e){if(0==a.omitTags.length&&0==a.omitSpecialTags)return!1;if(a.omitTags.indexOf(e)>-1)return!0;if(a.omitSpecialTags&&r.indexOf(e)>-1)return!0;return!1},load:function(){try{var n=t()?"-"+t():"";o.read=localStorage.getItem("snowstick-read"+n)?JSON.parse(localStorage.getItem("snowstick-read"+n)):[],o.leaf=localStorage.getItem("snowstick-leaf"+n)?JSON.parse(localStorage.getItem("snowstick-leaf"+n)):[],o.bookmark=localStorage.getItem("snowstick-bookmark"+n)?localStorage.getItem("snowstick-bookmark"+n):"",a.snowstick=o.leaf.length>0||o.read.length>0||o.bookmark.length>0}catch(e){a.snowstick=!1,console.log("Error checking local storage for SnowStick data: "+e.description)}var r;r=window.document.getElementById("storeArea")?window.document.getElementById("storeArea").querySelector('div[tiddler="DotGraphSettings"]'):window.document.querySelector('tw-passagedata[name="DotGraphSettings"]');if(r)l=r.innerText;else{var i,l;(i=window.document.getElementById("storeArea")?window.document.getElementById("storeArea").querySelector('div[tiddler="StorySettings"]'):window.document.querySelector('tw-passagedata[name="StorySettings"]'))&&i.innerText&&i.innerText.indexOf("dotgraph:")>-1&&(l=i.innerText.split("dotgraph:")[1].split("\n")[0])}if(l)try{l=JSON.parse(l),document.getElementById("storySettingsTextarea").value="::DotGraphSettings\r\n\r\n"+JSON.stringify(l,null,"\t")+"\r\n"}catch(e){console.log("Found but couldn't parse dotgraph settings from story: "+l)}else try{(l=localStorage.getItem("dotgraph-settings"+(t()?"-"+t():"")))&&(l=JSON.parse(l))}catch(e){console.log("Check of local storage for settings failed.")}_.each(l,function(e,t){"snowstick"==t&&e||(a[t]=e)}),a.paletteContrastColors=a.palette.map(function(t){return e.graph.contrastColor(t)}),a.showSettings&&(document.getElementById("notesDiv").remove(),document.getElementById("settingsDisplayDiv").style.display="block",s())},parse:function(e){a.checkpoints=!!document.getElementById("checkpointsCheckbox")&&document.getElementById("checkpointsCheckbox").checked,a.cluster=!!document.getElementById("clusterCheckbox")&&document.getElementById("clusterCheckbox").checked,a.clusterTags=document.getElementById("clusterTags")?i(document.getElementById("clusterTags").value):[],a.color=document.querySelector("input[name='colorCheckbox']:checked")?document.querySelector("input[name='colorCheckbox']:checked").value:"length",a.display=!document.getElementById("displayCheckbox")||document.getElementById("displayCheckbox").checked,a.ends=!!document.getElementById("endsCheckbox")&&document.getElementById("endsCheckbox").checked,a.engine=document.querySelector("input[name='engineCheckbox']:checked")?document.querySelector("input[name='engineCheckbox']:checked").value:"dot",a.omitSpecialPassages=!!document.getElementById("specialCheckbox")&&document.getElementById("specialCheckbox").checked,a.omitSpecialTags=!!document.getElementById("specialTagCheckbox")&&document.getElementById("specialTagCheckbox").checked,a.renumber=!!document.getElementById("renumberCheckbox")&&document.getElementById("renumberCheckbox").checked,a.rotation=document.querySelector("input[name='rotateCheckbox']:checked")?document.querySelector("input[name='rotateCheckbox']:checked").value:"TB",a.scale=document.getElementById("scaleInput")?document.getElementById("scaleInput").value:"",a.showNodeNames=!!document.getElementById("nodeCheckbox0")&&document.getElementById("nodeCheckbox0").checked,a.source=document.getElementById("sourceSelect").value,a.omitTags=document.getElementById("omitTags")?i(document.getElementById("omitTags").value):[],a.lastTag=!!document.getElementById("lastTagCheckbox")&&document.getElementById("lastTagCheckbox").checked,a.countWords=!!document.getElementById("wcCheckbox")&&document.getElementById("wcCheckbox").checked,a.trace=document.getElementById("trace")?(t=document.getElementById("trace").value,t=t.trim(),document.getElementById("traceFakeRadioButton").checked=t.length>0,t):"",e&&n();var t},scale:function(){a.scale=document.getElementById("scaleInput")?document.getElementById("scaleInput").value:"",e.graph.scale()},source:function(t){a.source=document.getElementById("sourceSelect").value,document.querySelectorAll("section.sourceSubSection").forEach(function(e){e.style.display="none"}),document.getElementById(a.source+"Section").style.display="block",e.graph.convert(t),t&&n()},toggle:function(e){e?document.getElementById(e).style.display=document.getElementById(e).offsetParent?"none":"":(a.hideGraph&&(document.getElementById("graphSection").style.display="none"),a.hideSettings&&(document.getElementById("settingsSection").style.display="none"),a.hideSource&&(document.getElementById("sourceSection").style.display="none"))},write:function(){var e=_.template('<input type="radio" id="nodeCheckbox0" name="nodeCheckbox" value="names" <%= (showNodeNames ? "checked" : "") %>/><label for="nodeCheckbox">&nbsp;Passage titles</label> \t\t\t<input type="radio" id="nodeCheckbox1" name="nodeCheckbox" value="pid"  <%= (showNodeNames ? "" : "checked") %> /><label for="nodeCheckbox">&nbsp;Passage ids (hover for title)</label> \t\t\t<input type="checkbox" id="renumberCheckbox" name="renumberCheckbox" <%= (renumber ? "checked" : "") %>/><label for="renumberCheckbox">&nbsp;renumber from 1</label><br /> \t\t\t<input type="radio" id="colorCheckbox0" name="colorCheckbox" value="bw" <%= (color == "bw" ? "checked" : "")%> />&nbsp;<label for="colorCheckbox0">Black & white</label> \t\t\t<input type="radio" id="colorCheckbox1" name="colorCheckbox" value="length" <%= (color == "length" ? "checked" : "")%> />&nbsp;<label for="colorCheckbox1">Color by node length</label> \t\t\t<input type="radio" id="colorCheckbox2" name="colorCheckbox" value="tag" <%= (color == "tag" ? "checked" : "")%>/>&nbsp;<label for="colorCheckbox2">Color by tag</label> '+(a.snowstick?'<input type="radio" id="colorCheckbox3" name="colorCheckbox" value="snow" <%= (color == "snow" ? "checked" : "")%>/>&nbsp;<label for="colorCheckbox3" title="SnowStick">Color by read state</label>':"")+'<br/> \t\t\t<input type="checkbox" id="displayCheckbox" name="displayCheckbox" checked/>&nbsp;<label for="displayCheckbox">Show display/include macros as links</label> \t\t\t<input type="checkbox" id="wcCheckbox" name="wcCheckbox" <%= (countWords ? "checked" : "") %> />&nbsp;<label for="wcCheckbox">Include word counts (hover)</label><br/> \t\t\t<input type="checkbox" id="specialCheckbox" <%= (omitSpecialPassages ? "checked" : "") %> />&nbsp;<label for="specialCheckbox">Omit&nbsp;special&nbsp;passages</label> (StoryTitle,&nbsp;etc.) \t\t\t<input type="checkbox" id="specialTagCheckbox" <%= (omitSpecialTags ? "checked" : "") %> />&nbsp;<label for="specialTagCheckbox">Omit&nbsp;by&nbsp;special&nbsp;tags</label> (script,&nbsp;etc.)<br/> \t\t\t<input type="radio" id="omitTagsFakeRadioButton" disabled/>&nbsp;<label for="omitTags">Omit by tag(s):</label>&nbsp;<input type="text" id="omitTags" placeholder="Separate tags with commas." value="<%=omitTags.join(", ")%>"/><br/> \t\t\t<input type="checkbox" id="checkpointsCheckbox" <%= (checkpoint ? "checked" : "") %> />&nbsp;<label for="checkpointsCheckbox" title="This changes the shape of checkpoint passages to a diamond.">Detect checkpoint tags</label> \t\t\t<input type="checkbox" id="endsCheckbox" <%= (ends == true ? "checked" : "") %>/>&nbsp;<label for="endsCheckbox" title="This changes the shape of end passages to an egg and puts diagonals on loose ends and disconnected nodes.">Detect end tags</label> \t\t\t<input type="checkbox" id="lastTagCheckbox" <%= (lastTag ? "checked" : "") %> />&nbsp;<label for="lastTagCheckbox" title="The cluster and color by tag options normally use the first tag on each passage.">Use last tag</label><br/> \t\t\t<input type="checkbox" id="clusterCheckbox" <%= (cluster ? "checked" : "") %> />&nbsp;<label for="clusterCheckbox">Cluster by tags:</label>&nbsp;<input type="text" id="clusterTags" placeholder="Separate tags with commas; leave blank for all tags." value="<%=clusterTags.join(", ")%>"/><br/> \t\t\t<input type="radio" id="traceFakeRadioButton" disabled/>&nbsp;<label for="trace" title="Traced nodes are hex-shaped.">Trace phrase:</label>&nbsp;<input type="input" id="trace" value="<%=trace%>" /> <br/> \t\t\t<input type="radio" id="engineCheckbox0" name="engineCheckbox" value="circo" <%= (engine == "circo" ? "checked" : "")%> />&nbsp;<label for="engineCheckbox0">circo</label> \t\t\t<input type="radio" id="engineCheckbox1" name="engineCheckbox" value="dot" <%= (engine == "dot" ? "checked" : "")%> />&nbsp;<label for="engineCheckbox1">dot</label> \t\t\t(<input type="radio" id="rotateCheckbox0" name="rotateCheckbox" value="TB" <%= (rotation == "TB" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox0" title="Top to bottom">&darr;</label> \t\t\t<input type="radio" id="rotateCheckbox1" name="rotateCheckbox" value="LR" <%= (rotation == "LR" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox1" title="Left to right">&rarr;</label> \t\t\t<input type="radio" id="rotateCheckbox2" name="rotateCheckbox" value="BT" <%= (rotation == "BT" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox2" title="Bottom to top">&uarr;</label> \t\t\t<input type="radio" id="rotateCheckbox3" name="rotateCheckbox" value="RL" <%= (rotation == "RL" ? "checked" : "")%> />&nbsp;<label for="rotateCheckbox3" title="Right to left">&larr;</label>) \t\t\t<input type="radio" id="engineCheckbox2" name="engineCheckbox" value="fdp" <%= (engine == "fdp" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox2">fdp</label> \t\t\t<input type="radio" id="engineCheckbox3" name="engineCheckbox" value="neato" <%= (engine == "neato" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox3">neato</label> \t\t\t<input type="radio" id="engineCheckbox4" name="engineCheckbox" value="osage" <%= (engine == "osage" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox4">osage</label> \t\t\t<input type="radio" id="engineCheckbox5" name="engineCheckbox" value="twopi" <%= (engine == "twopi" ? "checked" : "")%>/>&nbsp;<label for="engineCheckbox5">twopi</label><br/>');document.getElementById("settingsForm").innerHTML=e(a),document.getElementById("scaleInput").value=a.scale,document.getElementById("sourceSelect").value=a.source}};function t(){return window.document.querySelector("tw-storydata")?window.document.querySelector("tw-storydata").getAttribute("ifid").toUpperCase():""}function n(){try{localStorage.setItem("dotgraph-settings"+(t()?"-"+t():""),JSON.stringify(a))}catch(e){console.log("Failed to save settings to local storage.")}s()}function s(){a.showSettings&&(document.getElementById("settingsTextarea").value="::DotGraphSettings\r\n\r\n"+JSON.stringify(a,null,"\t")+"\r\n")}function i(e){for(var t=e.trim().split(","),n=[],a=0;a<t.length;a++){var o=t[a].trim();""!=o&&n.push(o)}return document.getElementById("omitTagsFakeRadioButton").checked=n.length>0,n}}(),e.story=function(){return{load:function(e,a){document.querySelector("tw-storydata, div#storeArea")&&document.querySelector("tw-storydata, div#storeArea").remove();a||(document.getElementById("graph").innerHTML="<p style='text-align:center;'><i>Loading</i> <tt>"+e+"</tt> ...<span id='loadingResult' style='color:tomato;'></span><p>");if(!e)return;if(e.indexOf("philome.la/")>-1){var s=e.split("/");e="https://"+s[2]+"/"+s[3]+"/"+s[4]+"/play/index.html"}e.indexOf("ifdb.tads.org")>-1&&(e=e.replace("ifdb.tads.org","ifdb.org"));e="mcdemarco.net"==location.hostname&&(e.indexOf("t.co/")>0||e.indexOf("ifdb.org/")>0||e.indexOf("philome.la/")>0)?n+e:t+encodeURIComponent(e);var r=new XMLHttpRequest;r.onreadystatechange=o,r.open("GET",e),r.responseType="document",r.send()},parse:function(){var t,n,o=window.document.getElementById("storeArea"),s=window.document.getElementsByTagName("tw-storydata")[0];if(o){i.twineVersion=1;var r="Untitled Story";o.querySelectorAll('[tiddler="StoryTitle"]').length&&(r=o.querySelectorAll('[tiddler="StoryTitle"]')[0].innerText),i.title=r}else s?(i.twineVersion=2,i.title=s.getAttribute("name")?s.getAttribute("name"):"Untitled",i.startNode=s.getAttribute("startnode")?s.getAttribute("startnode"):1):(i.title="Story not found",i.startNode="");n=o?o.querySelectorAll("div[tiddler]"):document.querySelectorAll("tw-passagedata");for(i.passages=function(t){for(var n=[],a=0;a<t.length;a++)n[a]=e.passage.parse(t[a],a);return n}(n),i.leaves=0,i.links=0,i.tightEnds=0,i.tagObject={},i.tags=[],i.targets={},t=0;t<i.passages.length;t++){var l=i.passages[t];o&&"Start"==l.name&&(i.startNode=t),a.ends&&e.passage.hasTag(l,a.endTag)&&i.tightEnds++,l.pid==i.startNode&&(i.startNodeName=l.name,i.reachable.push(l.name)),l.theTag&&(i.tagObject.hasOwnProperty(l.theTag)||(i.tagObject[l.theTag]=[],i.tags.push(l.theTag)),i.tagObject[l.theTag].push(l.name)),i.targets[l.name]=l.pid,i.links+=l.links.length,i.reachable=i.reachable.concat(_.map(l.links,_.first)),!l.leaf||l.omit||l.special&&a.omitSpecialPassages||i.leaves++}i.unreachable=_.difference(i.reachable,_.uniq(i.reachable)),i.reachable=_.uniq(i.reachable),i.maxLength=i.passages.reduce(function(e,t){return Math.max(e,t.textLength)},1),i.avLength=i.passages.reduce(function(e,t){return e+t.textLength},0)/i.passages.length,function(){if(document.getElementById("nodeCount").innerHTML=i.passages.length,a.omitSpecialPassages||a.omitTags.length>0){var e=i.passages.reduce(function(e,t){return e+(t.special&&a.omitSpecialPassages||t.omit?1:0)},0);document.getElementById("omitCount").innerHTML=" ("+(i.passages.length-e)+" included, "+e+" omitted, "+i.unreachable.length+" unreachable)"}if(document.getElementById("leafCount").innerHTML=i.leaves,a.ends){var t=i.leaves-i.tightEnds;document.getElementById("looseCount").innerHTML=" (including "+(t>0?t:0)+" loose end"+(1!=t?"s":"")+")"}else document.getElementById("looseCount").innerHTML="";document.getElementById("linkCount").innerHTML=i.links,document.getElementById("average").innerHTML=Math.round(i.links/Math.max(i.passages.length,1)*100)/100,document.getElementById("stats").setAttribute("title","Twine "+i.twineVersion)}()}};function o(){if(4!=this.readyState||200!=this.status&&304!=this.status)document.getElementById("loadingResult").innerHTML=" not found.";else{var t=this.response.querySelector("tw-storydata, div#storeArea");if(t)document.querySelector("body").append(t),a.scale="",t.children&&t.children.length&&t.children.length<20?a.showNodeNames=!0:a.showNodeNames=!1,e.settings.write(),e.graph.convert();else{var n,o=this.response.url?this.response.url:this.responseURL?this.responseURL:"";if(this.response.querySelector("meta[http-equiv=refresh]")){var s=this.response.querySelector("meta[http-equiv=refresh]").getAttribute("content");s&&(n=s.split(";URL=")[1])}else o.indexOf("itch.io")>0?(n=this.response.querySelector("iframe[src]")?this.response.querySelector("iframe[src]").getAttribute("src"):(new DOMParser).parseFromString(this.response.querySelector("div.iframe_placeholder").getAttribute("data-iframe"),"text/html").body.childNodes[0].getAttribute("src")).indexOf("http")<0&&(n="https:"+n):o.indexOf("ifdb.org")>0&&(n=this.response.querySelector("div#links-div a"))&&(n=n.getAttribute("href"));n?e.story.load(n,!0):document.getElementById("loadingResult").innerHTML=" failed."}}}}()}(dotGraph),window.onload=dotGraph.init.load();

},{"filesaver.js-npm":1,"underscore":2}]},{},[3]);
</script>
</body>
</html>
